var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import ono from '@jsdevtools/ono';
import { UniCoreMnemonicParseError, UniCoreWifParseError } from './errors';
import { generateMnemonic, isValidMnemonic, mnemonicToSeed } from './keys/bip39';
import { hdNodeToPublicKeyBuffer, hdNodeToPrivateKeyBuffer, hdToFirstHdNode, seedToHd } from './keys/hdkey';
import { hdPublicToEccPublicKey, hdPrivateToWif, isValidWif, privateKeyToPublic, wifToPrivateKey } from './keys/ecc';
import { generateAccountName } from "./utils";
const { subtle } = globalThis.crypto;
export const makeHdNodeByMnemonic = (mnemonic) => __awaiter(void 0, void 0, void 0, function* () {
    if (!isValidMnemonic(mnemonic)) {
        throw ono(new UniCoreMnemonicParseError('Invalid mnemonic'));
    }
    const seed = yield mnemonicToSeed(mnemonic);
    const hdBase = seedToHd(seed);
    const hdFirstNode = hdToFirstHdNode(hdBase);
    return hdFirstNode;
});
export const makePublicKeyByMnemonic = (mnemonic) => __awaiter(void 0, void 0, void 0, function* () {
    const hdFirstNode = yield makeHdNodeByMnemonic(mnemonic);
    const hdPublicKeyBuffer = hdNodeToPublicKeyBuffer(hdFirstNode);
    return hdPublicToEccPublicKey(hdPublicKeyBuffer);
});
export const makeAccount = (username, mnemonic, wif, pub) => {
    return {
        name: username,
        mnemonic,
        wif,
        pub,
    };
};
export const makeAccountByMnemonic = (username, mnemonic) => __awaiter(void 0, void 0, void 0, function* () {
    const hdFirstNode = yield makeHdNodeByMnemonic(mnemonic);
    const hdPublicKeyBuffer = hdNodeToPublicKeyBuffer(hdFirstNode);
    const hdPrivateKeyBuffer = hdNodeToPrivateKeyBuffer(hdFirstNode);
    return makeAccount(username, '', hdPrivateToWif(hdPrivateKeyBuffer), hdPublicToEccPublicKey(hdPublicKeyBuffer));
});
export const makeAccountByWif = (username, wif) => __awaiter(void 0, void 0, void 0, function* () {
    if (!isValidWif(wif)) {
        throw ono(new UniCoreWifParseError('Invalid wif'));
    }
    const publicKey = privateKeyToPublic(wifToPrivateKey(wif)).toLegacyString();
    return makeAccount(username, '', wif, publicKey);
});
export const generateAccount = () => __awaiter(void 0, void 0, void 0, function* () {
    const name = generateAccountName();
    const mnemonic = generateMnemonic();
    const seed = yield mnemonicToSeed(mnemonic);
    const hdBase = seedToHd(seed);
    const hdFirstNode = hdToFirstHdNode(hdBase);
    const hdPublicKeyBuffer = hdNodeToPublicKeyBuffer(hdFirstNode);
    const hdPrivateKeyBuffer = hdNodeToPrivateKeyBuffer(hdFirstNode);
    return makeAccount(name, mnemonic, hdPrivateToWif(hdPrivateKeyBuffer), hdPublicToEccPublicKey(hdPublicKeyBuffer));
});
export const checkPublicKey = (accountData, permissionName, publicKeyToCheck) => __awaiter(void 0, void 0, void 0, function* () {
    if (!accountData || !permissionName || !publicKeyToCheck) {
        return false;
    }
    const permission = accountData.permissions.find((p) => p.perm_name === permissionName);
    if (!permission) {
        return false;
    }
    return permission.required_auth.keys.some((key) => key.key === publicKeyToCheck);
});
export const generateKeyPair = () => __awaiter(void 0, void 0, void 0, function* () {
    const mnemonic = generateMnemonic();
    const seed = yield mnemonicToSeed(mnemonic);
    const hdBase = seedToHd(seed);
    const hdFirstNode = hdToFirstHdNode(hdBase);
    const hdPublicKeyBuffer = hdNodeToPublicKeyBuffer(hdFirstNode);
    const hdPrivateKeyBuffer = hdNodeToPrivateKeyBuffer(hdFirstNode);
    return { mnemonic, private_key: hdPrivateToWif(hdPrivateKeyBuffer), public_key: hdPublicToEccPublicKey(hdPublicKeyBuffer) };
});
// export const generateKeyPair = async() => {
//   const { privateKey, publicKey } = await subtle.generateKey(
//   {
//     name: "ECDSA",
//     namedCurve: "P-256",
//   },
//   true,
//   ["sign", "verify"]
//   );
//   let private_jwk = await subtle.exportKey("jwk", privateKey)
//   let private_hex = to_hex(ab2b(base64url_decode(private_jwk.d!)))
//   //SHA-256 hash with a 0x80 byte in front
//   let private_m256  = await sha256('80'+ private_hex )
//   //SHA-256 hash of the private key
//   let private_sha256  = await sha256(private_m256)
//   //first 4 bytes of the second SHA-256 hash
//   let private_four = private_sha256.substr(0,8);
//   //Base58 encode the binary data to get EOS private key
//   let private_wif = encode_b58('80'+ private_hex + private_four)
//   console.log("private_jwk: ", private_jwk)
//   let public_jwk = await subtle.exportKey("jwk", publicKey);
//   console.log("public_jwk: ", public_jwk)
//   const x_binary = ab2b(base64url_decode(public_jwk.x!));
//   const y_binary = ab2b(base64url_decode(public_jwk.y!));
//   const public_binary = x_binary.concat(y_binary);
//   console.log("public_binary: ", public_binary)
//   const public_ripemd160 = hash.ripemd160().update(new Uint8Array(public_binary)).digest('hex');
//   console.log("public_ripemd160: ", public_ripemd160)
//   let checksum = public_ripemd160.substr(0, 8); // Первые 4 байта, но в hex формате
//   let public_with_checksum = public_binary.concat(
//       public_ripemd160.substr(0, 8).split('').map(x => parseInt(x, 16))
//   );
//   console.log("public_with_checksum: ", public_with_checksum)
//   let public_base58 = encode_b58(public_with_checksum.map(x => x.toString(16)).join(''));
//   console.log("public_base58: ", public_base58)
//   let public_key = "PUB_R1_" + public_base58;
//   console.log("public_key: ", public_key)
//   return {private_wif, public_key}
// }
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi90cy9zcmMvYXV0aC9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSxPQUFPLEdBQUcsTUFBTSxpQkFBaUIsQ0FBQTtBQUVqQyxPQUFPLEVBQUMseUJBQXlCLEVBQUUsb0JBQW9CLEVBQUMsTUFBTSxVQUFVLENBQUE7QUFDeEUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLGVBQWUsRUFBRSxjQUFjLEVBQUUsTUFBTSxjQUFjLENBQUE7QUFDaEYsT0FBTyxFQUFFLHVCQUF1QixFQUFFLHdCQUF3QixFQUFFLGVBQWUsRUFBRSxRQUFRLEVBQUUsTUFBTSxjQUFjLENBQUE7QUFDM0csT0FBTyxFQUFDLHNCQUFzQixFQUFFLGNBQWMsRUFBRSxVQUFVLEVBQUUsa0JBQWtCLEVBQUUsZUFBZSxFQUFDLE1BQU0sWUFBWSxDQUFBO0FBQ2xILE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUs5QyxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQztBQUVyQyxNQUFNLENBQUMsTUFBTSxvQkFBb0IsR0FBRyxDQUFPLFFBQWdCLEVBQUUsRUFBRTtJQUM3RCxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxFQUFFO1FBQzlCLE1BQU0sR0FBRyxDQUFDLElBQUkseUJBQXlCLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFBO0tBQzdEO0lBRUQsTUFBTSxJQUFJLEdBQUcsTUFBTSxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUE7SUFDM0MsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQzdCLE1BQU0sV0FBVyxHQUFHLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUUzQyxPQUFPLFdBQVcsQ0FBQTtBQUNwQixDQUFDLENBQUEsQ0FBQTtBQUVELE1BQU0sQ0FBQyxNQUFNLHVCQUF1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NEQ7QUFDNUQsNERBQTREO0FBQzVELHFEQUFxRDtBQUVyRCxrREFBa0Q7QUFHbEQsbUdBQW1HO0FBRW5HLHdEQUF3RDtBQUN4RCxzRkFBc0Y7QUFFdEYscURBQXFEO0FBQ3JELDBFQUEwRTtBQUMxRSxPQUFPO0FBRVAsZ0VBQWdFO0FBRWhFLDRGQUE0RjtBQUU1RixrREFBa0Q7QUFFbEQsZ0RBQWdEO0FBQ2hELDRDQUE0QztBQUM1QyxxQ0FBcUM7QUFDckMsSUFBSSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBvbm8gZnJvbSAnQGpzZGV2dG9vbHMvb25vJ1xuXG5pbXBvcnQge1VuaUNvcmVNbmVtb25pY1BhcnNlRXJyb3IsIFVuaUNvcmVXaWZQYXJzZUVycm9yfSBmcm9tICcuL2Vycm9ycydcbmltcG9ydCB7IGdlbmVyYXRlTW5lbW9uaWMsIGlzVmFsaWRNbmVtb25pYywgbW5lbW9uaWNUb1NlZWQgfSBmcm9tICcuL2tleXMvYmlwMzknXG5pbXBvcnQgeyBoZE5vZGVUb1B1YmxpY0tleUJ1ZmZlciwgaGROb2RlVG9Qcml2YXRlS2V5QnVmZmVyLCBoZFRvRmlyc3RIZE5vZGUsIHNlZWRUb0hkIH0gZnJvbSAnLi9rZXlzL2hka2V5J1xuaW1wb3J0IHtoZFB1YmxpY1RvRWNjUHVibGljS2V5LCBoZFByaXZhdGVUb1dpZiwgaXNWYWxpZFdpZiwgcHJpdmF0ZUtleVRvUHVibGljLCB3aWZUb1ByaXZhdGVLZXl9IGZyb20gJy4va2V5cy9lY2MnXG5pbXBvcnQgeyBnZW5lcmF0ZUFjY291bnROYW1lIH0gZnJvbSBcIi4vdXRpbHNcIjtcblxuaW1wb3J0IHt0b19oZXgsIGFiMmIsIHNoYTI1NiwgZW5jb2RlX2I1OCwgYmFzZTY0dXJsX2RlY29kZX0gZnJvbSBcIi4va2V5cy9jcnlwdG9cIjtcbmltcG9ydCBoYXNoIGZyb20gJ2hhc2guanMnO1xuXG5jb25zdCB7IHN1YnRsZSB9ID0gZ2xvYmFsVGhpcy5jcnlwdG87XG5cbmV4cG9ydCBjb25zdCBtYWtlSGROb2RlQnlNbmVtb25pYyA9IGFzeW5jIChtbmVtb25pYzogc3RyaW5nKSA9PiB7XG4gIGlmICghaXNWYWxpZE1uZW1vbmljKG1uZW1vbmljKSkge1xuICAgIHRocm93IG9ubyhuZXcgVW5pQ29yZU1uZW1vbmljUGFyc2VFcnJvcignSW52YWxpZCBtbmVtb25pYycpKVxuICB9XG5cbiAgY29uc3Qgc2VlZCA9IGF3YWl0IG1uZW1vbmljVG9TZWVkKG1uZW1vbmljKVxuICBjb25zdCBoZEJhc2UgPSBzZWVkVG9IZChzZWVkKVxuICBjb25zdCBoZEZpcnN0Tm9kZSA9IGhkVG9GaXJzdEhkTm9kZShoZEJhc2UpXG5cbiAgcmV0dXJuIGhkRmlyc3ROb2RlXG59XG5cbmV4cG9ydCBjb25zdCBtYWtlUHVibGljS2V5QnlNbmVtb25pYyA9IGFzeW5jIChtbmVtb25pYzogc3RyaW5nKSA9PiB7XG4gIGNvbnN0IGhkRmlyc3ROb2RlID0gYXdhaXQgbWFrZUhkTm9kZUJ5TW5lbW9uaWMobW5lbW9uaWMpXG4gIGNvbnN0IGhkUHVibGljS2V5QnVmZmVyID0gaGROb2RlVG9QdWJsaWNLZXlCdWZmZXIoaGRGaXJzdE5vZGUpXG5cbiAgcmV0dXJuIGhkUHVibGljVG9FY2NQdWJsaWNLZXkoaGRQdWJsaWNLZXlCdWZmZXIpXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQWNjb3VudERhdGEge1xuICBuYW1lOiBzdHJpbmdcbiAgbW5lbW9uaWM6IHN0cmluZ1xuICB3aWY6IHN0cmluZ1xuICBwdWI6IHN0cmluZ1xufVxuXG5leHBvcnQgY29uc3QgbWFrZUFjY291bnQgPSAodXNlcm5hbWU6IHN0cmluZywgbW5lbW9uaWM6IHN0cmluZywgd2lmOiBzdHJpbmcsIHB1Yjogc3RyaW5nKTogQWNjb3VudERhdGEgPT4ge1xuICByZXR1cm4ge1xuICAgIG5hbWU6IHVzZXJuYW1lLFxuICAgIG1uZW1vbmljLFxuICAgIHdpZixcbiAgICBwdWIsXG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IG1ha2VBY2NvdW50QnlNbmVtb25pYyA9IGFzeW5jICh1c2VybmFtZTogc3RyaW5nLCBtbmVtb25pYzogc3RyaW5nKSA9PiB7XG4gIGNvbnN0IGhkRmlyc3ROb2RlID0gYXdhaXQgbWFrZUhkTm9kZUJ5TW5lbW9uaWMobW5lbW9uaWMpXG5cbiAgY29uc3QgaGRQdWJsaWNLZXlCdWZmZXIgPSBoZE5vZGVUb1B1YmxpY0tleUJ1ZmZlcihoZEZpcnN0Tm9kZSlcbiAgY29uc3QgaGRQcml2YXRlS2V5QnVmZmVyID0gaGROb2RlVG9Qcml2YXRlS2V5QnVmZmVyKGhkRmlyc3ROb2RlKVxuXG4gIHJldHVybiBtYWtlQWNjb3VudCh1c2VybmFtZSwgJycsIGhkUHJpdmF0ZVRvV2lmKGhkUHJpdmF0ZUtleUJ1ZmZlciksIGhkUHVibGljVG9FY2NQdWJsaWNLZXkoaGRQdWJsaWNLZXlCdWZmZXIpKVxufVxuXG5leHBvcnQgY29uc3QgbWFrZUFjY291bnRCeVdpZiA9IGFzeW5jICh1c2VybmFtZTogc3RyaW5nLCB3aWY6IHN0cmluZykgPT4ge1xuICBpZiAoIWlzVmFsaWRXaWYod2lmKSkge1xuICAgIHRocm93IG9ubyhuZXcgVW5pQ29yZVdpZlBhcnNlRXJyb3IoJ0ludmFsaWQgd2lmJykpXG4gIH1cblxuICBjb25zdCBwdWJsaWNLZXkgPSBwcml2YXRlS2V5VG9QdWJsaWMod2lmVG9Qcml2YXRlS2V5KHdpZikpLnRvTGVnYWN5U3RyaW5nKClcblxuICByZXR1cm4gbWFrZUFjY291bnQodXNlcm5hbWUsICcnLCB3aWYsIHB1YmxpY0tleSlcbn1cblxuZXhwb3J0IGNvbnN0IGdlbmVyYXRlQWNjb3VudCA9IGFzeW5jICgpOiBQcm9taXNlPEFjY291bnREYXRhPiA9PiB7XG4gIGNvbnN0IG5hbWUgPSBnZW5lcmF0ZUFjY291bnROYW1lKClcbiAgY29uc3QgbW5lbW9uaWMgPSBnZW5lcmF0ZU1uZW1vbmljKClcbiAgY29uc3Qgc2VlZCA9IGF3YWl0IG1uZW1vbmljVG9TZWVkKG1uZW1vbmljKVxuICBjb25zdCBoZEJhc2UgPSBzZWVkVG9IZChzZWVkKVxuICBjb25zdCBoZEZpcnN0Tm9kZSA9IGhkVG9GaXJzdEhkTm9kZShoZEJhc2UpXG5cbiAgY29uc3QgaGRQdWJsaWNLZXlCdWZmZXIgPSBoZE5vZGVUb1B1YmxpY0tleUJ1ZmZlcihoZEZpcnN0Tm9kZSlcbiAgY29uc3QgaGRQcml2YXRlS2V5QnVmZmVyID0gaGROb2RlVG9Qcml2YXRlS2V5QnVmZmVyKGhkRmlyc3ROb2RlKVxuXG4gIHJldHVybiBtYWtlQWNjb3VudChuYW1lLCBtbmVtb25pYywgaGRQcml2YXRlVG9XaWYoaGRQcml2YXRlS2V5QnVmZmVyKSwgaGRQdWJsaWNUb0VjY1B1YmxpY0tleShoZFB1YmxpY0tleUJ1ZmZlcikpXG59XG5cbmV4cG9ydCBjb25zdCBjaGVja1B1YmxpY0tleSA9IGFzeW5jIChhY2NvdW50RGF0YTogYW55LCBwZXJtaXNzaW9uTmFtZTogc3RyaW5nLCBwdWJsaWNLZXlUb0NoZWNrOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+ID0+IHtcbiAgaWYgKCFhY2NvdW50RGF0YSB8fCAhcGVybWlzc2lvbk5hbWUgfHwgIXB1YmxpY0tleVRvQ2hlY2spIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBjb25zdCBwZXJtaXNzaW9uID0gYWNjb3VudERhdGEucGVybWlzc2lvbnMuZmluZCgocDogYW55KSA9PiBwLnBlcm1fbmFtZSA9PT0gcGVybWlzc2lvbk5hbWUpO1xuICBpZiAoIXBlcm1pc3Npb24pIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICByZXR1cm4gcGVybWlzc2lvbi5yZXF1aXJlZF9hdXRoLmtleXMuc29tZSgoa2V5OiBhbnkpID0+IGtleS5rZXkgPT09IHB1YmxpY0tleVRvQ2hlY2spO1xufVxuXG5cbmV4cG9ydCBjb25zdCBnZW5lcmF0ZUtleVBhaXIgPSBhc3luYygpID0+IHtcbiAgY29uc3QgbW5lbW9uaWMgPSBnZW5lcmF0ZU1uZW1vbmljKClcbiAgY29uc3Qgc2VlZCA9IGF3YWl0IG1uZW1vbmljVG9TZWVkKG1uZW1vbmljKVxuICBjb25zdCBoZEJhc2UgPSBzZWVkVG9IZChzZWVkKVxuICBjb25zdCBoZEZpcnN0Tm9kZSA9IGhkVG9GaXJzdEhkTm9kZShoZEJhc2UpXG5cbiAgY29uc3QgaGRQdWJsaWNLZXlCdWZmZXIgPSBoZE5vZGVUb1B1YmxpY0tleUJ1ZmZlcihoZEZpcnN0Tm9kZSlcbiAgY29uc3QgaGRQcml2YXRlS2V5QnVmZmVyID0gaGROb2RlVG9Qcml2YXRlS2V5QnVmZmVyKGhkRmlyc3ROb2RlKVxuICBcbiAgcmV0dXJuIHttbmVtb25pYywgcHJpdmF0ZV9rZXk6IGhkUHJpdmF0ZVRvV2lmKGhkUHJpdmF0ZUtleUJ1ZmZlciksIHB1YmxpY19rZXk6IGhkUHVibGljVG9FY2NQdWJsaWNLZXkoaGRQdWJsaWNLZXlCdWZmZXIpfSAgXG59XG4vLyBleHBvcnQgY29uc3QgZ2VuZXJhdGVLZXlQYWlyID0gYXN5bmMoKSA9PiB7XG4vLyAgIGNvbnN0IHsgcHJpdmF0ZUtleSwgcHVibGljS2V5IH0gPSBhd2FpdCBzdWJ0bGUuZ2VuZXJhdGVLZXkoXG4vLyAgIHtcbi8vICAgICBuYW1lOiBcIkVDRFNBXCIsXG4vLyAgICAgbmFtZWRDdXJ2ZTogXCJQLTI1NlwiLFxuLy8gICB9LFxuLy8gICB0cnVlLFxuLy8gICBbXCJzaWduXCIsIFwidmVyaWZ5XCJdXG4vLyAgICk7XG5cbi8vICAgbGV0IHByaXZhdGVfandrID0gYXdhaXQgc3VidGxlLmV4cG9ydEtleShcImp3a1wiLCBwcml2YXRlS2V5KVxuICBcbi8vICAgbGV0IHByaXZhdGVfaGV4ID0gdG9faGV4KGFiMmIoYmFzZTY0dXJsX2RlY29kZShwcml2YXRlX2p3ay5kISkpKVxuICBcbi8vICAgLy9TSEEtMjU2IGhhc2ggd2l0aCBhIDB4ODAgYnl0ZSBpbiBmcm9udFxuLy8gICBsZXQgcHJpdmF0ZV9tMjU2ICA9IGF3YWl0IHNoYTI1NignODAnKyBwcml2YXRlX2hleCApXG5cbi8vICAgLy9TSEEtMjU2IGhhc2ggb2YgdGhlIHByaXZhdGUga2V5XG4vLyAgIGxldCBwcml2YXRlX3NoYTI1NiAgPSBhd2FpdCBzaGEyNTYocHJpdmF0ZV9tMjU2KVxuXG4vLyAgIC8vZmlyc3QgNCBieXRlcyBvZiB0aGUgc2Vjb25kIFNIQS0yNTYgaGFzaFxuLy8gICBsZXQgcHJpdmF0ZV9mb3VyID0gcHJpdmF0ZV9zaGEyNTYuc3Vic3RyKDAsOCk7XG5cbi8vICAgLy9CYXNlNTggZW5jb2RlIHRoZSBiaW5hcnkgZGF0YSB0byBnZXQgRU9TIHByaXZhdGUga2V5XG4vLyAgIGxldCBwcml2YXRlX3dpZiA9IGVuY29kZV9iNTgoJzgwJysgcHJpdmF0ZV9oZXggKyBwcml2YXRlX2ZvdXIpXG4vLyAgIGNvbnNvbGUubG9nKFwicHJpdmF0ZV9qd2s6IFwiLCBwcml2YXRlX2p3aylcblxuLy8gICBsZXQgcHVibGljX2p3ayA9IGF3YWl0IHN1YnRsZS5leHBvcnRLZXkoXCJqd2tcIiwgcHVibGljS2V5KTtcbi8vICAgY29uc29sZS5sb2coXCJwdWJsaWNfandrOiBcIiwgcHVibGljX2p3aylcbiAgXG4vLyAgIGNvbnN0IHhfYmluYXJ5ID0gYWIyYihiYXNlNjR1cmxfZGVjb2RlKHB1YmxpY19qd2sueCEpKTtcbi8vICAgY29uc3QgeV9iaW5hcnkgPSBhYjJiKGJhc2U2NHVybF9kZWNvZGUocHVibGljX2p3ay55ISkpO1xuLy8gICBjb25zdCBwdWJsaWNfYmluYXJ5ID0geF9iaW5hcnkuY29uY2F0KHlfYmluYXJ5KTtcblxuLy8gICBjb25zb2xlLmxvZyhcInB1YmxpY19iaW5hcnk6IFwiLCBwdWJsaWNfYmluYXJ5KVxuXG4gIFxuLy8gICBjb25zdCBwdWJsaWNfcmlwZW1kMTYwID0gaGFzaC5yaXBlbWQxNjAoKS51cGRhdGUobmV3IFVpbnQ4QXJyYXkocHVibGljX2JpbmFyeSkpLmRpZ2VzdCgnaGV4Jyk7XG4gIFxuLy8gICBjb25zb2xlLmxvZyhcInB1YmxpY19yaXBlbWQxNjA6IFwiLCBwdWJsaWNfcmlwZW1kMTYwKVxuLy8gICBsZXQgY2hlY2tzdW0gPSBwdWJsaWNfcmlwZW1kMTYwLnN1YnN0cigwLCA4KTsgLy8g0J/QtdGA0LLRi9C1IDQg0LHQsNC50YLQsCwg0L3QviDQsiBoZXgg0YTQvtGA0LzQsNGC0LVcbiAgXG4vLyAgIGxldCBwdWJsaWNfd2l0aF9jaGVja3N1bSA9IHB1YmxpY19iaW5hcnkuY29uY2F0KFxuLy8gICAgICAgcHVibGljX3JpcGVtZDE2MC5zdWJzdHIoMCwgOCkuc3BsaXQoJycpLm1hcCh4ID0+IHBhcnNlSW50KHgsIDE2KSlcbi8vICAgKTtcblxuLy8gICBjb25zb2xlLmxvZyhcInB1YmxpY193aXRoX2NoZWNrc3VtOiBcIiwgcHVibGljX3dpdGhfY2hlY2tzdW0pXG5cbi8vICAgbGV0IHB1YmxpY19iYXNlNTggPSBlbmNvZGVfYjU4KHB1YmxpY193aXRoX2NoZWNrc3VtLm1hcCh4ID0+IHgudG9TdHJpbmcoMTYpKS5qb2luKCcnKSk7XG5cbi8vICAgY29uc29sZS5sb2coXCJwdWJsaWNfYmFzZTU4OiBcIiwgcHVibGljX2Jhc2U1OClcblxuLy8gICBsZXQgcHVibGljX2tleSA9IFwiUFVCX1IxX1wiICsgcHVibGljX2Jhc2U1ODtcbi8vICAgY29uc29sZS5sb2coXCJwdWJsaWNfa2V5OiBcIiwgcHVibGljX2tleSlcbi8vICAgcmV0dXJuIHtwcml2YXRlX3dpZiwgcHVibGljX2tleX1cbi8vIH1cbiJdfQ==