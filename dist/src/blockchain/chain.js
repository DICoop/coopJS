import { TextDecoder, TextEncoder } from 'text-encoding';
import { Api, JsonRpc } from 'eosjs';
import { JsSignatureProvider } from 'eosjs/dist/eosjs-jssig';
import fetch from 'isomorphic-fetch';
import ono from "@jsdevtools/ono";
import btoa from 'btoa';
import atob from 'atob';
import unescape from 'core-js-pure/stable/unescape';
import escape from 'core-js-pure/stable/escape';
import EosioContract from './contracts/eosio';
import CoreContract from './contracts/core';
import PartnersContract from './contracts/partners';
import P2PContract from './contracts/p2p';
import NftContract from './contracts/nft';
import ReadApi from './readApi';
import { NotImplementedError } from './errors';
import BaseCrypt from "./baseCrypt";
import Wallet from "./wallet";
import Explorer from "./explorer";
const JsSignatureProviderMaker = ((wif) => Promise.resolve(new JsSignatureProvider([wif])));
class Chain {
    constructor(chainConfig, tableCodeConfig, authKeySearchCallback, signatureProviderMaker, chainCrypt, textDecoder, textEncoder) {
        this.name = chainConfig.name;
        this.tableCodeConfig = { ...tableCodeConfig, ...(chainConfig.tableCodeConfigOverride || {}) };
        this.readApi = new ReadApi(this.name, chainConfig.rpcEndpoints, chainConfig.balancingMode);
        this.explorer = new Explorer(chainConfig.explorerApiUrl);
        this.rpcByEndpoint = {};
        this.authKeyType = chainConfig.authKeyType || 'plain-auth-key';
        this.authKeySearchCallback = authKeySearchCallback;
        this.signatureProviderMaker = signatureProviderMaker || JsSignatureProviderMaker;
        this.chainCrypt = chainCrypt || new BaseCrypt();
        this.textDecoder = textDecoder;
        this.textEncoder = textEncoder;
        this.coreSymbol = chainConfig.coreSymbol;
        this.eosioContract = this.applyContract(EosioContract);
        this.coreContract = this.applyContract(CoreContract);
        this.partnersContract = this.applyContract(PartnersContract);
        this.p2pContract = this.applyContract(P2PContract);
        this.nftContract = this.applyContract(NftContract);
        this.wallets = (chainConfig.wallets || []).map(walletConfig => new Wallet(walletConfig, this.readApi));
    }
    get walletsSymbols() {
        return this.wallets.map(wallet => wallet.symbol);
    }
    getWalletBySymbol(symbol) {
        return this.wallets.find(wallet => wallet.symbol === symbol);
    }
    applyContract(contract) {
        return new contract(this.readApi, this.tableCodeConfig);
    }
    getCachedRpc() {
        const endpoint = this.readApi.getEndpoint();
        if (!this.rpcByEndpoint[endpoint]) {
            this.rpcByEndpoint[endpoint] = new JsonRpc(endpoint, { fetch });
        }
        return this.rpcByEndpoint[endpoint];
    }
    getEosInstanceBySignatureProvider(signatureProvider) {
        const rpc = this.getCachedRpc();
        return new Api({
            rpc,
            signatureProvider,
            // @ts-ignore
            textDecoder: new (this.textDecoder || TextDecoder)(),
            textEncoder: new (this.textEncoder || TextEncoder)(),
        });
    }
    /**
     * @deprecated since version 1.0.2
     */
    getEosPassInstance(wif) {
        const signatureProvider = new JsSignatureProvider([wif]);
        return this.getEosInstanceBySignatureProvider(signatureProvider);
    }
    async makeEosInstance(authKey) {
        const signatureProvider = await this.signatureProviderMaker(authKey);
        return this.getEosInstanceBySignatureProvider(signatureProvider);
    }
    getAuthKey(authKeyQuery, authKeyType) {
        const localAuthKeyType = authKeyType || this.authKeyType;
        if (localAuthKeyType === 'plain-auth-key') {
            return authKeyQuery;
        }
        if (localAuthKeyType === 'auth-key-search-callback') {
            if (!this.authKeySearchCallback) {
                throw ono(new Error('For authKeyType=wif-search-callback wifSearchCallback need to define'));
            }
            return this.authKeySearchCallback(authKeyQuery);
        }
        throw ono(new NotImplementedError('Not implemented authKeyType'));
    }
    async transactByAuthKey(authKey, transaction, config) {
        const eos = await this.makeEosInstance(authKey);
        return eos.transact(transaction, config);
    }
    async transact(authKeyQuery, transaction, config, authKeyType) {
        const authKey = await this.getAuthKey(authKeyQuery, authKeyType);
        if (!authKey) {
            throw ono(new Error('authKey cannot be empty'));
        }
        return this.transactByAuthKey(authKey, transaction, config);
    }
    async encryptMessage(authKeyQuery, publicKey, message, memo, authKeyType) {
        const authKey = await this.getAuthKey(authKeyQuery, authKeyType);
        if (!authKey) {
            throw ono(new Error('authKey cannot be empty'));
        }
        const permissionKey = await this.readApi.getPermissionKeyByName(publicKey, "active");
        if (!permissionKey) {
            throw ono(new Error('permissionKey cannot be empty'));
        }
        const preparedMessage = btoa(unescape(encodeURIComponent(message)));
        return this.chainCrypt.encrypt(authKey, permissionKey, preparedMessage, memo);
    }
    async decryptMessage(authKeyQuery, publicKey, message, memo, authKeyType) {
        const authKey = await this.getAuthKey(authKeyQuery, authKeyType);
        if (!authKey) {
            throw ono(new Error('authKey cannot be empty'));
        }
        let permissionKey = await this.readApi.getPermissionKeyByName(publicKey, "gateway");
        if (!permissionKey) {
            permissionKey = await this.readApi.getPermissionKeyByName(publicKey, "active");
        }
        if (!permissionKey) {
            throw ono(new Error('permissionKey cannot be empty'));
        }
        const decryptedMessage = await this.chainCrypt.decrypt(authKey, permissionKey, message, memo);
        return decodeURIComponent(escape(atob(decryptedMessage)));
    }
    async signMessage(authKeyQuery, publicKey, message, authKeyType) {
        const authKey = await this.getAuthKey(authKeyQuery, authKeyType);
        if (!authKey) {
            throw ono(new Error('authKey cannot be empty'));
        }
        const preparedMessage = btoa(unescape(encodeURIComponent(message)));
        return this.chainCrypt.sign(authKey, preparedMessage);
    }
    async verifyMessage(publicKey, message, signature) {
        const preparedMessage = btoa(unescape(encodeURIComponent(message)));
        return this.chainCrypt.verify(publicKey, preparedMessage, signature);
    }
}
export default Chain;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhaW4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi90cy9zcmMvYmxvY2tjaGFpbi9jaGFpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsV0FBVyxFQUFFLFdBQVcsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUN2RCxPQUFPLEVBQUMsR0FBRyxFQUFFLE9BQU8sRUFBQyxNQUFNLE9BQU8sQ0FBQztBQUNuQyxPQUFPLEVBQUMsbUJBQW1CLEVBQUMsTUFBTSx3QkFBd0IsQ0FBQztBQUczRCxPQUFPLEtBQUssTUFBTSxrQkFBa0IsQ0FBQTtBQUNwQyxPQUFPLEdBQUcsTUFBTSxpQkFBaUIsQ0FBQztBQUNsQyxPQUFPLElBQUksTUFBTSxNQUFNLENBQUM7QUFDeEIsT0FBTyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQ3hCLE9BQU8sUUFBUSxNQUFNLDhCQUE4QixDQUFBO0FBQ25ELE9BQU8sTUFBTSxNQUFNLDRCQUE0QixDQUFBO0FBRS9DLE9BQU8sYUFBYSxNQUFNLG1CQUFtQixDQUFBO0FBQzdDLE9BQU8sWUFBWSxNQUFNLGtCQUFrQixDQUFBO0FBQzNDLE9BQU8sZ0JBQWdCLE1BQU0sc0JBQXNCLENBQUE7QUFDbkQsT0FBTyxXQUFXLE1BQU0saUJBQWlCLENBQUE7QUFDekMsT0FBTyxXQUFXLE1BQU0saUJBQWlCLENBQUE7QUFTekMsT0FBTyxPQUFPLE1BQU0sV0FBVyxDQUFBO0FBRS9CLE9BQU8sRUFBQyxtQkFBbUIsRUFBQyxNQUFNLFVBQVUsQ0FBQztBQUM3QyxPQUFPLFNBQVMsTUFBTSxhQUFhLENBQUM7QUFDcEMsT0FBTyxNQUFNLE1BQU0sVUFBVSxDQUFDO0FBQzlCLE9BQU8sUUFBUSxNQUFNLFlBQVksQ0FBQztBQU1sQyxNQUFNLHdCQUF3QixHQUFHLENBQUMsQ0FBQyxHQUFXLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxtQkFBbUIsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxD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QUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQTtRQUU3RixPQUFPLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDN0QsQ0FBQztJQUVELEtBQUssQ0FBQyxXQUFXLENBQ2IsWUFBb0IsRUFDcEIsU0FBaUIsRUFDakIsT0FBZSxFQUNmLFdBQXlCO1FBRXpCLE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLEVBQUUsV0FBVyxDQUFDLENBQUE7UUFFaEUsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNWLE1BQU0sR0FBRyxDQUFDLElBQUksS0FBSyxDQUFDLHlCQUF5QixDQUFDLENBQUMsQ0FBQTtTQUNsRDtRQUVELE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ25FLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLGVBQWUsQ0FBQyxDQUFBO0lBQ3pELENBQUM7SUFFRCxLQUFLLENBQUMsYUFBYSxDQUNmLFNBQWlCLEVBQ2pCLE9BQWUsRUFDZixTQUFpQjtRQUVqQixNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUNuRSxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxlQUFlLEVBQUUsU0FBUyxDQUFDLENBQUE7SUFDeEUsQ0FBQztDQUNKO0FBRUQsZUFBZSxLQUFLLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1RleHREZWNvZGVyLCBUZXh0RW5jb2Rlcn0gZnJvbSAndGV4dC1lbmNvZGluZyc7XG5pbXBvcnQge0FwaSwgSnNvblJwY30gZnJvbSAnZW9zanMnO1xuaW1wb3J0IHtKc1NpZ25hdHVyZVByb3ZpZGVyfSBmcm9tICdlb3Nqcy9kaXN0L2Vvc2pzLWpzc2lnJztcbmltcG9ydCB7U2lnbmF0dXJlUHJvdmlkZXIsIFRyYW5zYWN0Q29uZmlnLCBUcmFuc2FjdGlvbiwgVHJhbnNhY3RSZXN1bHR9IGZyb20gJ2Vvc2pzL2Rpc3QvZW9zanMtYXBpLWludGVyZmFjZXMnO1xuaW1wb3J0IHtQdXNoVHJhbnNhY3Rpb25BcmdzLCBSZWFkT25seVRyYW5zYWN0UmVzdWx0fSBmcm9tICdlb3Nqcy9kaXN0L2Vvc2pzLXJwYy1pbnRlcmZhY2VzJztcbmltcG9ydCBmZXRjaCBmcm9tICdpc29tb3JwaGljLWZldGNoJ1xuaW1wb3J0IG9ubyBmcm9tIFwiQGpzZGV2dG9vbHMvb25vXCI7XG5pbXBvcnQgYnRvYSBmcm9tICdidG9hJztcbmltcG9ydCBhdG9iIGZyb20gJ2F0b2InO1xuaW1wb3J0IHVuZXNjYXBlIGZyb20gJ2NvcmUtanMtcHVyZS9zdGFibGUvdW5lc2NhcGUnXG5pbXBvcnQgZXNjYXBlIGZyb20gJ2NvcmUtanMtcHVyZS9zdGFibGUvZXNjYXBlJ1xuXG5pbXBvcnQgRW9zaW9Db250cmFjdCBmcm9tICcuL2NvbnRyYWN0cy9lb3NpbydcbmltcG9ydCBDb3JlQ29udHJhY3QgZnJvbSAnLi9jb250cmFjdHMvY29yZSdcbmltcG9ydCBQYXJ0bmVyc0NvbnRyYWN0IGZyb20gJy4vY29udHJhY3RzL3BhcnRuZXJzJ1xuaW1wb3J0IFAyUENvbnRyYWN0IGZyb20gJy4vY29udHJhY3RzL3AycCdcbmltcG9ydCBOZnRDb250cmFjdCBmcm9tICcuL2NvbnRyYWN0cy9uZnQnXG5pbXBvcnQge1xuICAgIEF1dGhLZXlTZWFyY2hDYWxsYmFjayxcbiAgICBBdXRoS2V5VHlwZSxcbiAgICBDaGFpbkNvbmZpZyxcbiAgICBDaGFpbkNyeXB0LFxuICAgIFNpZ25hdHVyZVByb3ZpZGVyTWFrZXIsXG4gICAgVGFibGVDb2RlQ29uZmlnXG59IGZyb20gJy4vdHlwZXMnXG5pbXBvcnQgUmVhZEFwaSBmcm9tICcuL3JlYWRBcGknXG5pbXBvcnQgQmFzZUNvbnRyYWN0IGZyb20gXCIuL2NvbnRyYWN0cy9iYXNlXCI7XG5pbXBvcnQge05vdEltcGxlbWVudGVkRXJyb3J9IGZyb20gJy4vZXJyb3JzJztcbmltcG9ydCBCYXNlQ3J5cHQgZnJvbSBcIi4vYmFzZUNyeXB0XCI7XG5pbXBvcnQgV2FsbGV0IGZyb20gXCIuL3dhbGxldFwiO1xuaW1wb3J0IEV4cGxvcmVyIGZyb20gXCIuL2V4cGxvcmVyXCI7XG5cbmludGVyZmFjZSBScGNzQnlFbmRwb2ludHMge1xuICAgIFtrZXk6IHN0cmluZ106IEpzb25ScGNcbn1cblxuY29uc3QgSnNTaWduYXR1cmVQcm92aWRlck1ha2VyID0gKCh3aWY6IHN0cmluZykgPT4gUHJvbWlzZS5yZXNvbHZlKG5ldyBKc1NpZ25hdHVyZVByb3ZpZGVyKFt3aWZdKSkpXG5cbmNsYXNzIENoYWluIHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IG5hbWU6IHN0cmluZ1xuICAgIHB1YmxpYyByZWFkQXBpOiBSZWFkQXBpXG4gICAgcHVibGljIGV4cGxvcmVyOiBFeHBsb3JlclxuICAgIHByaXZhdGUgcmVhZG9ubHkgdGFibGVDb2RlQ29uZmlnOiBUYWJsZUNvZGVDb25maWdcbiAgICBwcml2YXRlIHJlYWRvbmx5IHJwY0J5RW5kcG9pbnQ6IFJwY3NCeUVuZHBvaW50c1xuICAgIHByaXZhdGUgcmVhZG9ubHkgYXV0aEtleVR5cGU6IEF1dGhLZXlUeXBlXG4gICAgcHJpdmF0ZSByZWFkb25seSBhdXRoS2V5U2VhcmNoQ2FsbGJhY2s/OiBBdXRoS2V5U2VhcmNoQ2FsbGJhY2tcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNpZ25hdHVyZVByb3ZpZGVyTWFrZXI6IFNpZ25hdHVyZVByb3ZpZGVyTWFrZXJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNoYWluQ3J5cHQ6IENoYWluQ3J5cHRcbiAgICBwcml2YXRlIHRleHREZWNvZGVyPzogdHlwZW9mIFRleHREZWNvZGVyXG4gICAgcHJpdmF0ZSB0ZXh0RW5jb2Rlcj86IHR5cGVvZiBUZXh0RW5jb2RlclxuXG4gICAgcHVibGljIGVvc2lvQ29udHJhY3Q6IEVvc2lvQ29udHJhY3RcbiAgICBwdWJsaWMgY29yZUNvbnRyYWN0OiBDb3JlQ29udHJhY3RcbiAgICBwdWJsaWMgcGFydG5lcnNDb250cmFjdDogUGFydG5lcnNDb250cmFjdFxuICAgIHB1YmxpYyBwMnBDb250cmFjdDogUDJQQ29udHJhY3RcbiAgICBwdWJsaWMgbmZ0Q29udHJhY3Q6IE5mdENvbnRyYWN0XG5cbiAgICBwdWJsaWMgd2FsbGV0czogV2FsbGV0W11cbiAgICBwdWJsaWMgcmVhZG9ubHkgY29yZVN5bWJvbD86IHN0cmluZ1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIGNoYWluQ29uZmlnOiBDaGFpbkNvbmZpZyxcbiAgICAgICAgdGFibGVDb2RlQ29uZmlnOiBUYWJsZUNvZGVDb25maWcsXG4gICAgICAgIGF1dGhLZXlTZWFyY2hDYWxsYmFjaz86IEF1dGhLZXlTZWFyY2hDYWxsYmFjayxcbiAgICAgICAgc2lnbmF0dXJlUHJvdmlkZXJNYWtlcj86IFNpZ25hdHVyZVByb3ZpZGVyTWFrZXIsXG4gICAgICAgIGNoYWluQ3J5cHQ/OiBDaGFpbkNyeXB0LFxuICAgICAgICB0ZXh0RGVjb2Rlcj86IHR5cGVvZiBUZXh0RGVjb2RlcixcbiAgICAgICAgdGV4dEVuY29kZXI/OiB0eXBlb2YgVGV4dEVuY29kZXIsXG4gICAgKSB7XG4gICAgICAgIHRoaXMubmFtZSA9IGNoYWluQ29uZmlnLm5hbWVcbiAgICAgICAgdGhpcy50YWJsZUNvZGVDb25maWcgPSB7Li4udGFibGVDb2RlQ29uZmlnLCAuLi4oY2hhaW5Db25maWcudGFibGVDb2RlQ29uZmlnT3ZlcnJpZGUgfHwge30pfVxuICAgICAgICB0aGlzLnJlYWRBcGkgPSBuZXcgUmVhZEFwaSh0aGlzLm5hbWUsIGNoYWluQ29uZmlnLnJwY0VuZHBvaW50cywgY2hhaW5Db25maWcuYmFsYW5jaW5nTW9kZSlcbiAgICAgICAgdGhpcy5leHBsb3JlciA9IG5ldyBFeHBsb3JlcihjaGFpbkNvbmZpZy5leHBsb3JlckFwaVVybClcbiAgICAgICAgdGhpcy5ycGNCeUVuZHBvaW50ID0ge31cbiAgICAgICAgdGhpcy5hdXRoS2V5VHlwZSA9IGNoYWluQ29uZmlnLmF1dGhLZXlUeXBlIHx8ICdwbGFpbi1hdXRoLWtleSdcbiAgICAgICAgdGhpcy5hdXRoS2V5U2VhcmNoQ2FsbGJhY2sgPSBhdXRoS2V5U2VhcmNoQ2FsbGJhY2tcbiAgICAgICAgdGhpcy5zaWduYXR1cmVQcm92aWRlck1ha2VyID0gc2lnbmF0dXJlUHJvdmlkZXJNYWtlciB8fCBKc1NpZ25hdHVyZVByb3ZpZGVyTWFrZXJcbiAgICAgICAgdGhpcy5jaGFpbkNyeXB0ID0gY2hhaW5DcnlwdCB8fCBuZXcgQmFzZUNyeXB0KClcbiAgICAgICAgdGhpcy50ZXh0RGVjb2RlciA9IHRleHREZWNvZGVyXG4gICAgICAgIHRoaXMudGV4dEVuY29kZXIgPSB0ZXh0RW5jb2RlclxuICAgICAgICB0aGlzLmNvcmVTeW1ib2wgPSBjaGFpbkNvbmZpZy5jb3JlU3ltYm9sXG5cbiAgICAgICAgdGhpcy5lb3Npb0NvbnRyYWN0ID0gdGhpcy5hcHBseUNvbnRyYWN0KEVvc2lvQ29udHJhY3QpXG4gICAgICAgIHRoaXMuY29yZUNvbnRyYWN0ID0gdGhpcy5hcHBseUNvbnRyYWN0KENvcmVDb250cmFjdClcbiAgICAgICAgdGhpcy5wYXJ0bmVyc0NvbnRyYWN0ID0gdGhpcy5hcHBseUNvbnRyYWN0KFBhcnRuZXJzQ29udHJhY3QpXG4gICAgICAgIHRoaXMucDJwQ29udHJhY3QgPSB0aGlzLmFwcGx5Q29udHJhY3QoUDJQQ29udHJhY3QpXG4gICAgICAgIHRoaXMubmZ0Q29udHJhY3QgPSB0aGlzLmFwcGx5Q29udHJhY3QoTmZ0Q29udHJhY3QpXG5cbiAgICAgICAgdGhpcy53YWxsZXRzID0gKGNoYWluQ29uZmlnLndhbGxldHMgfHwgW10pLm1hcCh3YWxsZXRDb25maWcgPT4gbmV3IFdhbGxldCh3YWxsZXRDb25maWcsIHRoaXMucmVhZEFwaSkpXG4gICAgfVxuXG4gICAgZ2V0IHdhbGxldHNTeW1ib2xzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy53YWxsZXRzLm1hcCh3YWxsZXQgPT4gd2FsbGV0LnN5bWJvbClcbiAgICB9XG5cbiAgICBnZXRXYWxsZXRCeVN5bWJvbChzeW1ib2w6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gdGhpcy53YWxsZXRzLmZpbmQod2FsbGV0ID0+IHdhbGxldC5zeW1ib2wgPT09IHN5bWJvbClcbiAgICB9XG5cbiAgICBhcHBseUNvbnRyYWN0PFQgZXh0ZW5kcyBCYXNlQ29udHJhY3Q+KGNvbnRyYWN0OiB7IG5ldyguLi5hcmdzOiBhbnlbXSk6IFQ7IH0pOiBUIHtcbiAgICAgICAgcmV0dXJuIG5ldyBjb250cmFjdCh0aGlzLnJlYWRBcGksIHRoaXMudGFibGVDb2RlQ29uZmlnKVxuICAgIH1cblxuICAgIGdldENhY2hlZFJwYygpIHtcbiAgICAgICAgY29uc3QgZW5kcG9pbnQgPSB0aGlzLnJlYWRBcGkuZ2V0RW5kcG9pbnQoKVxuICAgICAgICBpZiAoIXRoaXMucnBjQnlFbmRwb2ludFtlbmRwb2ludF0pIHtcbiAgICAgICAgICAgIHRoaXMucnBjQnlFbmRwb2ludFtlbmRwb2ludF0gPSBuZXcgSnNvblJwYyhlbmRwb2ludCwge2ZldGNofSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5ycGNCeUVuZHBvaW50W2VuZHBvaW50XVxuICAgIH1cblxuICAgIGdldEVvc0luc3RhbmNlQnlTaWduYXR1cmVQcm92aWRlcihzaWduYXR1cmVQcm92aWRlcjogU2lnbmF0dXJlUHJvdmlkZXIpIHtcbiAgICAgICAgY29uc3QgcnBjID0gdGhpcy5nZXRDYWNoZWRScGMoKVxuXG4gICAgICAgIHJldHVybiBuZXcgQXBpKHtcbiAgICAgICAgICAgIHJwYyxcbiAgICAgICAgICAgIHNpZ25hdHVyZVByb3ZpZGVyLFxuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgdGV4dERlY29kZXI6IG5ldyAodGhpcy50ZXh0RGVjb2RlciB8fCBUZXh0RGVjb2RlcikoKSxcbiAgICAgICAgICAgIHRleHRFbmNvZGVyOiBuZXcgKHRoaXMudGV4dEVuY29kZXIgfHwgVGV4dEVuY29kZXIpKCksXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBkZXByZWNhdGVkIHNpbmNlIHZlcnNpb24gMS4wLjJcbiAgICAgKi9cbiAgICBnZXRFb3NQYXNzSW5zdGFuY2Uod2lmOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3Qgc2lnbmF0dXJlUHJvdmlkZXIgPSBuZXcgSnNTaWduYXR1cmVQcm92aWRlcihbd2lmXSk7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEVvc0luc3RhbmNlQnlTaWduYXR1cmVQcm92aWRlcihzaWduYXR1cmVQcm92aWRlcik7XG4gICAgfVxuXG4gICAgYXN5bmMgbWFrZUVvc0luc3RhbmNlKGF1dGhLZXk6IHN0cmluZykge1xuICAgICAgICBjb25zdCBzaWduYXR1cmVQcm92aWRlciA9IGF3YWl0IHRoaXMuc2lnbmF0dXJlUHJvdmlkZXJNYWtlcihhdXRoS2V5KVxuICAgICAgICByZXR1cm4gdGhpcy5nZXRFb3NJbnN0YW5jZUJ5U2lnbmF0dXJlUHJvdmlkZXIoc2lnbmF0dXJlUHJvdmlkZXIpO1xuICAgIH1cblxuICAgIGdldEF1dGhLZXkoYXV0aEtleVF1ZXJ5OiBzdHJpbmcsIGF1dGhLZXlUeXBlPzogQXV0aEtleVR5cGUpIHtcbiAgICAgICAgY29uc3QgbG9jYWxBdXRoS2V5VHlwZSA9IGF1dGhLZXlUeXBlIHx8IHRoaXMuYXV0aEtleVR5cGVcblxuICAgICAgICBpZiAobG9jYWxBdXRoS2V5VHlwZSA9PT0gJ3BsYWluLWF1dGgta2V5Jykge1xuICAgICAgICAgICAgcmV0dXJuIGF1dGhLZXlRdWVyeVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGxvY2FsQXV0aEtleVR5cGUgPT09ICdhdXRoLWtleS1zZWFyY2gtY2FsbGJhY2snKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuYXV0aEtleVNlYXJjaENhbGxiYWNrKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgb25vKG5ldyBFcnJvcignRm9yIGF1dGhLZXlUeXBlPXdpZi1zZWFyY2gtY2FsbGJhY2sgd2lmU2VhcmNoQ2FsbGJhY2sgbmVlZCB0byBkZWZpbmUnKSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0aGlzLmF1dGhLZXlTZWFyY2hDYWxsYmFjayhhdXRoS2V5UXVlcnkpXG4gICAgICAgIH1cblxuICAgICAgICB0aHJvdyBvbm8obmV3IE5vdEltcGxlbWVudGVkRXJyb3IoJ05vdCBpbXBsZW1lbnRlZCBhdXRoS2V5VHlwZScpKVxuICAgIH1cblxuICAgIGFzeW5jIHRyYW5zYWN0QnlBdXRoS2V5KFxuICAgICAgICBhdXRoS2V5OiBzdHJpbmcsXG4gICAgICAgIHRyYW5zYWN0aW9uOiBUcmFuc2FjdGlvbixcbiAgICAgICAgY29uZmlnPzogVHJhbnNhY3RDb25maWdcbiAgICApOiBQcm9taXNlPFRyYW5zYWN0UmVzdWx0IHwgUmVhZE9ubHlUcmFuc2FjdFJlc3VsdCB8IFB1c2hUcmFuc2FjdGlvbkFyZ3M+IHtcbiAgICAgICAgY29uc3QgZW9zID0gYXdhaXQgdGhpcy5tYWtlRW9zSW5zdGFuY2UoYXV0aEtleSlcbiAgICAgICAgcmV0dXJuIGVvcy50cmFuc2FjdCh0cmFuc2FjdGlvbiwgY29uZmlnKVxuICAgIH1cblxuICAgIGFzeW5jIHRyYW5zYWN0KFxuICAgICAgICBhdXRoS2V5UXVlcnk6IHN0cmluZyxcbiAgICAgICAgdHJhbnNhY3Rpb246IFRyYW5zYWN0aW9uLFxuICAgICAgICBjb25maWc/OiBUcmFuc2FjdENvbmZpZyxcbiAgICAgICAgYXV0aEtleVR5cGU/OiBBdXRoS2V5VHlwZSxcbiAgICApOiBQcm9taXNlPFRyYW5zYWN0UmVzdWx0IHwgUmVhZE9ubHlUcmFuc2FjdFJlc3VsdCB8IFB1c2hUcmFuc2FjdGlvbkFyZ3M+IHtcbiAgICAgICAgY29uc3QgYXV0aEtleSA9IGF3YWl0IHRoaXMuZ2V0QXV0aEtleShhdXRoS2V5UXVlcnksIGF1dGhLZXlUeXBlKVxuXG4gICAgICAgIGlmICghYXV0aEtleSkge1xuICAgICAgICAgICAgdGhyb3cgb25vKG5ldyBFcnJvcignYXV0aEtleSBjYW5ub3QgYmUgZW1wdHknKSlcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLnRyYW5zYWN0QnlBdXRoS2V5KGF1dGhLZXksIHRyYW5zYWN0aW9uLCBjb25maWcpXG4gICAgfVxuXG4gICAgYXN5bmMgZW5jcnlwdE1lc3NhZ2UoXG4gICAgICAgIGF1dGhLZXlRdWVyeTogc3RyaW5nLFxuICAgICAgICBwdWJsaWNLZXk6IHN0cmluZyxcbiAgICAgICAgbWVzc2FnZTogc3RyaW5nLFxuICAgICAgICBtZW1vPzogc3RyaW5nLFxuICAgICAgICBhdXRoS2V5VHlwZT86IEF1dGhLZXlUeXBlLFxuICAgICkge1xuICAgICAgICBjb25zdCBhdXRoS2V5ID0gYXdhaXQgdGhpcy5nZXRBdXRoS2V5KGF1dGhLZXlRdWVyeSwgYXV0aEtleVR5cGUpXG5cbiAgICAgICAgaWYgKCFhdXRoS2V5KSB7XG4gICAgICAgICAgICB0aHJvdyBvbm8obmV3IEVycm9yKCdhdXRoS2V5IGNhbm5vdCBiZSBlbXB0eScpKVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcGVybWlzc2lvbktleSA9IGF3YWl0IHRoaXMucmVhZEFwaS5nZXRQZXJtaXNzaW9uS2V5QnlOYW1lKHB1YmxpY0tleSwgXCJhY3RpdmVcIilcblxuICAgICAgICBpZiAoIXBlcm1pc3Npb25LZXkpIHtcbiAgICAgICAgICAgIHRocm93IG9ubyhuZXcgRXJyb3IoJ3Blcm1pc3Npb25LZXkgY2Fubm90IGJlIGVtcHR5JykpXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwcmVwYXJlZE1lc3NhZ2UgPSBidG9hKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChtZXNzYWdlKSkpXG4gICAgICAgIHJldHVybiB0aGlzLmNoYWluQ3J5cHQuZW5jcnlwdChhdXRoS2V5LCBwZXJtaXNzaW9uS2V5LCBwcmVwYXJlZE1lc3NhZ2UsIG1lbW8pXG4gICAgfVxuXG4gICAgYXN5bmMgZGVjcnlwdE1lc3NhZ2UoXG4gICAgICAgIGF1dGhLZXlRdWVyeTogc3RyaW5nLFxuICAgICAgICBwdWJsaWNLZXk6IHN0cmluZyxcbiAgICAgICAgbWVzc2FnZTogc3RyaW5nLFxuICAgICAgICBtZW1vPzogc3RyaW5nLFxuICAgICAgICBhdXRoS2V5VHlwZT86IEF1dGhLZXlUeXBlLFxuICAgICkge1xuICAgICAgICBjb25zdCBhdXRoS2V5ID0gYXdhaXQgdGhpcy5nZXRBdXRoS2V5KGF1dGhLZXlRdWVyeSwgYXV0aEtleVR5cGUpXG5cbiAgICAgICAgaWYgKCFhdXRoS2V5KSB7XG4gICAgICAgICAgICB0aHJvdyBvbm8obmV3IEVycm9yKCdhdXRoS2V5IGNhbm5vdCBiZSBlbXB0eScpKVxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHBlcm1pc3Npb25LZXkgPSBhd2FpdCB0aGlzLnJlYWRBcGkuZ2V0UGVybWlzc2lvbktleUJ5TmFtZShwdWJsaWNLZXksIFwiZ2F0ZXdheVwiKVxuXG4gICAgICAgIGlmICghcGVybWlzc2lvbktleSkge1xuICAgICAgICAgICAgcGVybWlzc2lvbktleSA9IGF3YWl0IHRoaXMucmVhZEFwaS5nZXRQZXJtaXNzaW9uS2V5QnlOYW1lKHB1YmxpY0tleSwgXCJhY3RpdmVcIilcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghcGVybWlzc2lvbktleSkge1xuICAgICAgICAgICAgdGhyb3cgb25vKG5ldyBFcnJvcigncGVybWlzc2lvbktleSBjYW5ub3QgYmUgZW1wdHknKSlcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGRlY3J5cHRlZE1lc3NhZ2UgPSBhd2FpdCB0aGlzLmNoYWluQ3J5cHQuZGVjcnlwdChhdXRoS2V5LCBwZXJtaXNzaW9uS2V5LCBtZXNzYWdlLCBtZW1vKVxuXG4gICAgICAgIHJldHVybiBkZWNvZGVVUklDb21wb25lbnQoZXNjYXBlKGF0b2IoZGVjcnlwdGVkTWVzc2FnZSkpKVxuICAgIH1cblxuICAgIGFzeW5jIHNpZ25NZXNzYWdlKFxuICAgICAgICBhdXRoS2V5UXVlcnk6IHN0cmluZyxcbiAgICAgICAgcHVibGljS2V5OiBzdHJpbmcsXG4gICAgICAgIG1lc3NhZ2U6IHN0cmluZyxcbiAgICAgICAgYXV0aEtleVR5cGU/OiBBdXRoS2V5VHlwZSxcbiAgICApIHtcbiAgICAgICAgY29uc3QgYXV0aEtleSA9IGF3YWl0IHRoaXMuZ2V0QXV0aEtleShhdXRoS2V5UXVlcnksIGF1dGhLZXlUeXBlKVxuXG4gICAgICAgIGlmICghYXV0aEtleSkge1xuICAgICAgICAgICAgdGhyb3cgb25vKG5ldyBFcnJvcignYXV0aEtleSBjYW5ub3QgYmUgZW1wdHknKSlcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHByZXBhcmVkTWVzc2FnZSA9IGJ0b2EodW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KG1lc3NhZ2UpKSlcbiAgICAgICAgcmV0dXJuIHRoaXMuY2hhaW5DcnlwdC5zaWduKGF1dGhLZXksIHByZXBhcmVkTWVzc2FnZSlcbiAgICB9XG5cbiAgICBhc3luYyB2ZXJpZnlNZXNzYWdlKFxuICAgICAgICBwdWJsaWNLZXk6IHN0cmluZyxcbiAgICAgICAgbWVzc2FnZTogc3RyaW5nLFxuICAgICAgICBzaWduYXR1cmU6IHN0cmluZyxcbiAgICApIHtcbiAgICAgICAgY29uc3QgcHJlcGFyZWRNZXNzYWdlID0gYnRvYSh1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQobWVzc2FnZSkpKVxuICAgICAgICByZXR1cm4gdGhpcy5jaGFpbkNyeXB0LnZlcmlmeShwdWJsaWNLZXksIHByZXBhcmVkTWVzc2FnZSwgc2lnbmF0dXJlKVxuICAgIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgQ2hhaW5cbiJdfQ==