import { TextDecoder, TextEncoder } from 'text-encoding';
import { Api, JsonRpc } from 'eosjs';
import { JsSignatureProvider } from 'eosjs/dist/eosjs-jssig';
import fetch from 'isomorphic-fetch';
import ono from "@jsdevtools/ono";
import btoa from 'btoa';
import atob from 'atob';
import unescape from 'core-js-pure/stable/unescape';
import escape from 'core-js-pure/stable/escape';
import EosioContract from './contracts/eosio';
import CoreContract from './contracts/core';
import PartnersContract from './contracts/partners';
import P2PContract from './contracts/p2p';
import NftContract from './contracts/nft';
import ReadApi from './readApi';
import { NotImplementedError } from './errors';
import BaseCrypt from "./baseCrypt";
import Wallet from "./wallet";
import Explorer from "./explorer";
const JsSignatureProviderMaker = ((wif) => Promise.resolve(new JsSignatureProvider([wif])));
class Chain {
    constructor(chainConfig, tableCodeConfig, authKeySearchCallback, signatureProviderMaker, chainCrypt, textDecoder, textEncoder) {
        this.name = chainConfig.name;
        this.tableCodeConfig = { ...tableCodeConfig, ...(chainConfig.tableCodeConfigOverride || {}) };
        this.readApi = new ReadApi(this.name, chainConfig.rpcEndpoints, chainConfig.balancingMode);
        this.explorer = new Explorer(chainConfig.explorerApiUrl);
        this.rpcByEndpoint = {};
        this.authKeyType = chainConfig.authKeyType || 'plain-auth-key';
        this.authKeySearchCallback = authKeySearchCallback;
        this.signatureProviderMaker = signatureProviderMaker || JsSignatureProviderMaker;
        this.chainCrypt = chainCrypt || new BaseCrypt();
        this.textDecoder = textDecoder;
        this.textEncoder = textEncoder;
        this.coreSymbol = chainConfig.coreSymbol;
        this.eosioContract = this.applyContract(EosioContract);
        this.coreContract = this.applyContract(CoreContract);
        this.partnersContract = this.applyContract(PartnersContract);
        this.p2pContract = this.applyContract(P2PContract);
        this.nftContract = this.applyContract(NftContract);
        this.wallets = (chainConfig.wallets || []).map(walletConfig => new Wallet(walletConfig, this.readApi));
    }
    get walletsSymbols() {
        return this.wallets.map(wallet => wallet.symbol);
    }
    getWalletBySymbol(symbol) {
        return this.wallets.find(wallet => wallet.symbol === symbol);
    }
    applyContract(contract) {
        return new contract(this.readApi, this.tableCodeConfig);
    }
    getCachedRpc() {
        const endpoint = this.readApi.getEndpoint();
        if (!this.rpcByEndpoint[endpoint]) {
            this.rpcByEndpoint[endpoint] = new JsonRpc(endpoint, { fetch });
        }
        return this.rpcByEndpoint[endpoint];
    }
    getEosInstanceBySignatureProvider(signatureProvider) {
        const rpc = this.getCachedRpc();
        return new Api({
            rpc,
            signatureProvider,
            // @ts-ignore
            textDecoder: new (this.textDecoder || TextDecoder)(),
            textEncoder: new (this.textEncoder || TextEncoder)(),
        });
    }
    /**
     * @deprecated since version 1.0.2
     */
    getEosPassInstance(wif) {
        const signatureProvider = new JsSignatureProvider([wif]);
        return this.getEosInstanceBySignatureProvider(signatureProvider);
    }
    async makeEosInstance(authKey) {
        const signatureProvider = await this.signatureProviderMaker(authKey);
        return this.getEosInstanceBySignatureProvider(signatureProvider);
    }
    getAuthKey(authKeyQuery, authKeyType) {
        const localAuthKeyType = authKeyType || this.authKeyType;
        if (localAuthKeyType === 'plain-auth-key') {
            return authKeyQuery;
        }
        if (localAuthKeyType === 'auth-key-search-callback') {
            if (!this.authKeySearchCallback) {
                throw ono(new Error('For authKeyType=wif-search-callback wifSearchCallback need to define'));
            }
            return this.authKeySearchCallback(authKeyQuery);
        }
        throw ono(new NotImplementedError('Not implemented authKeyType'));
    }
    async transactByAuthKey(authKey, transaction, config) {
        const eos = await this.makeEosInstance(authKey);
        return eos.transact(transaction, config);
    }
    async transact(authKeyQuery, transaction, config, authKeyType) {
        const authKey = await this.getAuthKey(authKeyQuery, authKeyType);
        if (!authKey) {
            throw ono(new Error('authKey cannot be empty'));
        }
        return this.transactByAuthKey(authKey, transaction, config);
    }
    async encryptMessage(authKeyQuery, publicKey, message, memo, authKeyType) {
        const authKey = await this.getAuthKey(authKeyQuery, authKeyType);
        if (!authKey) {
            throw ono(new Error('authKey cannot be empty'));
        }
        const permissionKey = await this.readApi.getPermissionKeyByName(publicKey, "active");
        if (!permissionKey) {
            throw ono(new Error('permissionKey cannot be empty'));
        }
        const preparedMessage = btoa(unescape(encodeURIComponent(message)));
        return this.chainCrypt.encrypt(authKey, permissionKey, preparedMessage, memo);
    }
    async decryptMessage(authKeyQuery, publicKey, message, memo, authKeyType) {
        const authKey = await this.getAuthKey(authKeyQuery, authKeyType);
        if (!authKey) {
            throw ono(new Error('authKey cannot be empty'));
        }
        let permissionKey = await this.readApi.getPermissionKeyByName(publicKey, "gateway");
        if (!permissionKey) {
            permissionKey = await this.readApi.getPermissionKeyByName(publicKey, "active");
        }
        if (!permissionKey) {
            throw ono(new Error('permissionKey cannot be empty'));
        }
        const decryptedMessage = await this.chainCrypt.decrypt(authKey, permissionKey, message, memo);
        return decodeURIComponent(escape(atob(decryptedMessage)));
    }
    makeValueAsStr(value) {
        if (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean') {
            return String(value);
        }
        if (typeof value === 'object') {
            if (Array.isArray(value)) {
                return value.map(item => this.makeValueAsStr(item)).join(',');
            }
            const keys = Object.keys(value).sort();
            return keys.map(key => `${key}=${this.makeValueAsStr(value[key])}`).join('&');
        }
        throw ono(new Error('Unsupported value type'));
    }
    objToStableMessage(dict) {
        return this.makeValueAsStr(dict);
    }
    btoaEscape(str) {
        return btoa(unescape(encodeURIComponent(str)));
    }
    async signMessage(authKeyQuery, publicKey, message, authKeyType) {
        const authKey = await this.getAuthKey(authKeyQuery, authKeyType);
        if (!authKey) {
            throw ono(new Error('authKey cannot be empty'));
        }
        const preparedMessage = this.btoaEscape(message);
        return this.chainCrypt.sign(authKey, preparedMessage);
    }
    async verifyMessage(publicKey, message, signature) {
        const preparedMessage = this.btoaEscape(message);
        return this.chainCrypt.verify(publicKey, preparedMessage, signature);
    }
    async signObject(authKeyQuery, publicKey, dict, authKeyType) {
        const message = this.objToStableMessage(dict);
        return this.signMessage(authKeyQuery, publicKey, message, authKeyType);
    }
    async verifyObject(publicKey, dict, signature) {
        const message = this.objToStableMessage(dict);
        return this.verifyMessage(publicKey, message, signature);
    }
}
export default Chain;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhaW4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi90cy9zcmMvYmxvY2tjaGFpbi9jaGFpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsV0FBVyxFQUFFLFdBQVcsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUN2RCxPQUFPLEVBQUMsR0FBRyxFQUFFLE9BQU8sRUFBQyxNQUFNLE9BQU8sQ0FBQztBQUNuQyxPQUFPLEVBQUMsbUJBQW1CLEVBQUMsTUFBTSx3QkFBd0IsQ0FBQztBQUczRCxPQUFPLEtBQUssTUFBTSxrQkFBa0IsQ0FBQTtBQUNwQyxPQUFPLEdBQUcsTUFBTSxpQkFBaUIsQ0FBQztBQUNsQyxPQUFPLElBQUksTUFBTSxNQUFNLENBQUM7QUFDeEIsT0FBTyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQ3hCLE9BQU8sUUFBUSxNQUFNLDhCQUE4QixDQUFBO0FBQ25ELE9BQU8sTUFBTSxNQUFNLDRCQUE0QixDQUFBO0FBRS9DLE9BQU8sYUFBYSxNQUFNLG1CQUFtQixDQUFBO0FBQzdDLE9BQU8sWUFBWSxNQUFNLGtCQUFrQixDQUFBO0FBQzNDLE9BQU8sZ0JBQWdCLE1BQU0sc0JBQXNCLENBQUE7QUFDbkQsT0FBTyxXQUFXLE1BQU0saUJBQWlCLENBQUE7QUFDekMsT0FBTyxXQUFXLE1BQU0saUJBQWlCLENBQUE7QUFTekMsT0FBTyxPQUFPLE1BQU0sV0FBVyxDQUFBO0FBRS9CLE9BQU8sRUFBQyxtQkFBbUIsRUFBQyxNQUFNLFVBQVUsQ0FBQztBQUM3QyxPQUFPLFNBQVMsTUFBTSxhQUFhLENBQUM7QUFDcEMsT0FBTyxNQUFNLE1BQU0sVUFBVSxDQUFDO0FBQzlCLE9BQU8sUUFBUSxNQUFNLFlBQVksQ0FBQztBQU1sQyxNQUFNLHdCQUF3QixHQUFHLENBQUMsQ0FBQyxHQUFXLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxtQkFBbUIsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxD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O1FBRWpCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUM3QyxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxFQUFFLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQTtJQUM1RCxDQUFDO0NBQ0o7QUFFRCxlQUFlLEtBQUssQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7VGV4dERlY29kZXIsIFRleHRFbmNvZGVyfSBmcm9tICd0ZXh0LWVuY29kaW5nJztcbmltcG9ydCB7QXBpLCBKc29uUnBjfSBmcm9tICdlb3Nqcyc7XG5pbXBvcnQge0pzU2lnbmF0dXJlUHJvdmlkZXJ9IGZyb20gJ2Vvc2pzL2Rpc3QvZW9zanMtanNzaWcnO1xuaW1wb3J0IHtTaWduYXR1cmVQcm92aWRlciwgVHJhbnNhY3RDb25maWcsIFRyYW5zYWN0aW9uLCBUcmFuc2FjdFJlc3VsdH0gZnJvbSAnZW9zanMvZGlzdC9lb3Nqcy1hcGktaW50ZXJmYWNlcyc7XG5pbXBvcnQge1B1c2hUcmFuc2FjdGlvbkFyZ3MsIFJlYWRPbmx5VHJhbnNhY3RSZXN1bHR9IGZyb20gJ2Vvc2pzL2Rpc3QvZW9zanMtcnBjLWludGVyZmFjZXMnO1xuaW1wb3J0IGZldGNoIGZyb20gJ2lzb21vcnBoaWMtZmV0Y2gnXG5pbXBvcnQgb25vIGZyb20gXCJAanNkZXZ0b29scy9vbm9cIjtcbmltcG9ydCBidG9hIGZyb20gJ2J0b2EnO1xuaW1wb3J0IGF0b2IgZnJvbSAnYXRvYic7XG5pbXBvcnQgdW5lc2NhcGUgZnJvbSAnY29yZS1qcy1wdXJlL3N0YWJsZS91bmVzY2FwZSdcbmltcG9ydCBlc2NhcGUgZnJvbSAnY29yZS1qcy1wdXJlL3N0YWJsZS9lc2NhcGUnXG5cbmltcG9ydCBFb3Npb0NvbnRyYWN0IGZyb20gJy4vY29udHJhY3RzL2Vvc2lvJ1xuaW1wb3J0IENvcmVDb250cmFjdCBmcm9tICcuL2NvbnRyYWN0cy9jb3JlJ1xuaW1wb3J0IFBhcnRuZXJzQ29udHJhY3QgZnJvbSAnLi9jb250cmFjdHMvcGFydG5lcnMnXG5pbXBvcnQgUDJQQ29udHJhY3QgZnJvbSAnLi9jb250cmFjdHMvcDJwJ1xuaW1wb3J0IE5mdENvbnRyYWN0IGZyb20gJy4vY29udHJhY3RzL25mdCdcbmltcG9ydCB7XG4gICAgQXV0aEtleVNlYXJjaENhbGxiYWNrLFxuICAgIEF1dGhLZXlUeXBlLFxuICAgIENoYWluQ29uZmlnLFxuICAgIENoYWluQ3J5cHQsXG4gICAgU2lnbmF0dXJlUHJvdmlkZXJNYWtlcixcbiAgICBUYWJsZUNvZGVDb25maWdcbn0gZnJvbSAnLi90eXBlcydcbmltcG9ydCBSZWFkQXBpIGZyb20gJy4vcmVhZEFwaSdcbmltcG9ydCBCYXNlQ29udHJhY3QgZnJvbSBcIi4vY29udHJhY3RzL2Jhc2VcIjtcbmltcG9ydCB7Tm90SW1wbGVtZW50ZWRFcnJvcn0gZnJvbSAnLi9lcnJvcnMnO1xuaW1wb3J0IEJhc2VDcnlwdCBmcm9tIFwiLi9iYXNlQ3J5cHRcIjtcbmltcG9ydCBXYWxsZXQgZnJvbSBcIi4vd2FsbGV0XCI7XG5pbXBvcnQgRXhwbG9yZXIgZnJvbSBcIi4vZXhwbG9yZXJcIjtcblxuaW50ZXJmYWNlIFJwY3NCeUVuZHBvaW50cyB7XG4gICAgW2tleTogc3RyaW5nXTogSnNvblJwY1xufVxuXG5jb25zdCBKc1NpZ25hdHVyZVByb3ZpZGVyTWFrZXIgPSAoKHdpZjogc3RyaW5nKSA9PiBQcm9taXNlLnJlc29sdmUobmV3IEpzU2lnbmF0dXJlUHJvdmlkZXIoW3dpZl0pKSlcblxuY2xhc3MgQ2hhaW4ge1xuICAgIHByaXZhdGUgcmVhZG9ubHkgbmFtZTogc3RyaW5nXG4gICAgcHVibGljIHJlYWRBcGk6IFJlYWRBcGlcbiAgICBwdWJsaWMgZXhwbG9yZXI6IEV4cGxvcmVyXG4gICAgcHJpdmF0ZSByZWFkb25seSB0YWJsZUNvZGVDb25maWc6IFRhYmxlQ29kZUNvbmZpZ1xuICAgIHByaXZhdGUgcmVhZG9ubHkgcnBjQnlFbmRwb2ludDogUnBjc0J5RW5kcG9pbnRzXG4gICAgcHJpdmF0ZSByZWFkb25seSBhdXRoS2V5VHlwZTogQXV0aEtleVR5cGVcbiAgICBwcml2YXRlIHJlYWRvbmx5IGF1dGhLZXlTZWFyY2hDYWxsYmFjaz86IEF1dGhLZXlTZWFyY2hDYWxsYmFja1xuICAgIHByaXZhdGUgcmVhZG9ubHkgc2lnbmF0dXJlUHJvdmlkZXJNYWtlcjogU2lnbmF0dXJlUHJvdmlkZXJNYWtlclxuICAgIHByaXZhdGUgcmVhZG9ubHkgY2hhaW5DcnlwdDogQ2hhaW5DcnlwdFxuICAgIHByaXZhdGUgdGV4dERlY29kZXI/OiB0eXBlb2YgVGV4dERlY29kZXJcbiAgICBwcml2YXRlIHRleHRFbmNvZGVyPzogdHlwZW9mIFRleHRFbmNvZGVyXG5cbiAgICBwdWJsaWMgZW9zaW9Db250cmFjdDogRW9zaW9Db250cmFjdFxuICAgIHB1YmxpYyBjb3JlQ29udHJhY3Q6IENvcmVDb250cmFjdFxuICAgIHB1YmxpYyBwYXJ0bmVyc0NvbnRyYWN0OiBQYXJ0bmVyc0NvbnRyYWN0XG4gICAgcHVibGljIHAycENvbnRyYWN0OiBQMlBDb250cmFjdFxuICAgIHB1YmxpYyBuZnRDb250cmFjdDogTmZ0Q29udHJhY3RcblxuICAgIHB1YmxpYyB3YWxsZXRzOiBXYWxsZXRbXVxuICAgIHB1YmxpYyByZWFkb25seSBjb3JlU3ltYm9sPzogc3RyaW5nXG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgY2hhaW5Db25maWc6IENoYWluQ29uZmlnLFxuICAgICAgICB0YWJsZUNvZGVDb25maWc6IFRhYmxlQ29kZUNvbmZpZyxcbiAgICAgICAgYXV0aEtleVNlYXJjaENhbGxiYWNrPzogQXV0aEtleVNlYXJjaENhbGxiYWNrLFxuICAgICAgICBzaWduYXR1cmVQcm92aWRlck1ha2VyPzogU2lnbmF0dXJlUHJvdmlkZXJNYWtlcixcbiAgICAgICAgY2hhaW5DcnlwdD86IENoYWluQ3J5cHQsXG4gICAgICAgIHRleHREZWNvZGVyPzogdHlwZW9mIFRleHREZWNvZGVyLFxuICAgICAgICB0ZXh0RW5jb2Rlcj86IHR5cGVvZiBUZXh0RW5jb2RlcixcbiAgICApIHtcbiAgICAgICAgdGhpcy5uYW1lID0gY2hhaW5Db25maWcubmFtZVxuICAgICAgICB0aGlzLnRhYmxlQ29kZUNvbmZpZyA9IHsuLi50YWJsZUNvZGVDb25maWcsIC4uLihjaGFpbkNvbmZpZy50YWJsZUNvZGVDb25maWdPdmVycmlkZSB8fCB7fSl9XG4gICAgICAgIHRoaXMucmVhZEFwaSA9IG5ldyBSZWFkQXBpKHRoaXMubmFtZSwgY2hhaW5Db25maWcucnBjRW5kcG9pbnRzLCBjaGFpbkNvbmZpZy5iYWxhbmNpbmdNb2RlKVxuICAgICAgICB0aGlzLmV4cGxvcmVyID0gbmV3IEV4cGxvcmVyKGNoYWluQ29uZmlnLmV4cGxvcmVyQXBpVXJsKVxuICAgICAgICB0aGlzLnJwY0J5RW5kcG9pbnQgPSB7fVxuICAgICAgICB0aGlzLmF1dGhLZXlUeXBlID0gY2hhaW5Db25maWcuYXV0aEtleVR5cGUgfHwgJ3BsYWluLWF1dGgta2V5J1xuICAgICAgICB0aGlzLmF1dGhLZXlTZWFyY2hDYWxsYmFjayA9IGF1dGhLZXlTZWFyY2hDYWxsYmFja1xuICAgICAgICB0aGlzLnNpZ25hdHVyZVByb3ZpZGVyTWFrZXIgPSBzaWduYXR1cmVQcm92aWRlck1ha2VyIHx8IEpzU2lnbmF0dXJlUHJvdmlkZXJNYWtlclxuICAgICAgICB0aGlzLmNoYWluQ3J5cHQgPSBjaGFpbkNyeXB0IHx8IG5ldyBCYXNlQ3J5cHQoKVxuICAgICAgICB0aGlzLnRleHREZWNvZGVyID0gdGV4dERlY29kZXJcbiAgICAgICAgdGhpcy50ZXh0RW5jb2RlciA9IHRleHRFbmNvZGVyXG4gICAgICAgIHRoaXMuY29yZVN5bWJvbCA9IGNoYWluQ29uZmlnLmNvcmVTeW1ib2xcblxuICAgICAgICB0aGlzLmVvc2lvQ29udHJhY3QgPSB0aGlzLmFwcGx5Q29udHJhY3QoRW9zaW9Db250cmFjdClcbiAgICAgICAgdGhpcy5jb3JlQ29udHJhY3QgPSB0aGlzLmFwcGx5Q29udHJhY3QoQ29yZUNvbnRyYWN0KVxuICAgICAgICB0aGlzLnBhcnRuZXJzQ29udHJhY3QgPSB0aGlzLmFwcGx5Q29udHJhY3QoUGFydG5lcnNDb250cmFjdClcbiAgICAgICAgdGhpcy5wMnBDb250cmFjdCA9IHRoaXMuYXBwbHlDb250cmFjdChQMlBDb250cmFjdClcbiAgICAgICAgdGhpcy5uZnRDb250cmFjdCA9IHRoaXMuYXBwbHlDb250cmFjdChOZnRDb250cmFjdClcblxuICAgICAgICB0aGlzLndhbGxldHMgPSAoY2hhaW5Db25maWcud2FsbGV0cyB8fCBbXSkubWFwKHdhbGxldENvbmZpZyA9PiBuZXcgV2FsbGV0KHdhbGxldENvbmZpZywgdGhpcy5yZWFkQXBpKSlcbiAgICB9XG5cbiAgICBnZXQgd2FsbGV0c1N5bWJvbHMoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLndhbGxldHMubWFwKHdhbGxldCA9PiB3YWxsZXQuc3ltYm9sKVxuICAgIH1cblxuICAgIGdldFdhbGxldEJ5U3ltYm9sKHN5bWJvbDogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiB0aGlzLndhbGxldHMuZmluZCh3YWxsZXQgPT4gd2FsbGV0LnN5bWJvbCA9PT0gc3ltYm9sKVxuICAgIH1cblxuICAgIGFwcGx5Q29udHJhY3Q8VCBleHRlbmRzIEJhc2VDb250cmFjdD4oY29udHJhY3Q6IHsgbmV3KC4uLmFyZ3M6IGFueVtdKTogVDsgfSk6IFQge1xuICAgICAgICByZXR1cm4gbmV3IGNvbnRyYWN0KHRoaXMucmVhZEFwaSwgdGhpcy50YWJsZUNvZGVDb25maWcpXG4gICAgfVxuXG4gICAgZ2V0Q2FjaGVkUnBjKCkge1xuICAgICAgICBjb25zdCBlbmRwb2ludCA9IHRoaXMucmVhZEFwaS5nZXRFbmRwb2ludCgpXG4gICAgICAgIGlmICghdGhpcy5ycGNCeUVuZHBvaW50W2VuZHBvaW50XSkge1xuICAgICAgICAgICAgdGhpcy5ycGNCeUVuZHBvaW50W2VuZHBvaW50XSA9IG5ldyBKc29uUnBjKGVuZHBvaW50LCB7ZmV0Y2h9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLnJwY0J5RW5kcG9pbnRbZW5kcG9pbnRdXG4gICAgfVxuXG4gICAgZ2V0RW9zSW5zdGFuY2VCeVNpZ25hdHVyZVByb3ZpZGVyKHNpZ25hdHVyZVByb3ZpZGVyOiBTaWduYXR1cmVQcm92aWRlcikge1xuICAgICAgICBjb25zdCBycGMgPSB0aGlzLmdldENhY2hlZFJwYygpXG5cbiAgICAgICAgcmV0dXJuIG5ldyBBcGkoe1xuICAgICAgICAgICAgcnBjLFxuICAgICAgICAgICAgc2lnbmF0dXJlUHJvdmlkZXIsXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICB0ZXh0RGVjb2RlcjogbmV3ICh0aGlzLnRleHREZWNvZGVyIHx8IFRleHREZWNvZGVyKSgpLFxuICAgICAgICAgICAgdGV4dEVuY29kZXI6IG5ldyAodGhpcy50ZXh0RW5jb2RlciB8fCBUZXh0RW5jb2RlcikoKSxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAxLjAuMlxuICAgICAqL1xuICAgIGdldEVvc1Bhc3NJbnN0YW5jZSh3aWY6IHN0cmluZykge1xuICAgICAgICBjb25zdCBzaWduYXR1cmVQcm92aWRlciA9IG5ldyBKc1NpZ25hdHVyZVByb3ZpZGVyKFt3aWZdKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RW9zSW5zdGFuY2VCeVNpZ25hdHVyZVByb3ZpZGVyKHNpZ25hdHVyZVByb3ZpZGVyKTtcbiAgICB9XG5cbiAgICBhc3luYyBtYWtlRW9zSW5zdGFuY2UoYXV0aEtleTogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IHNpZ25hdHVyZVByb3ZpZGVyID0gYXdhaXQgdGhpcy5zaWduYXR1cmVQcm92aWRlck1ha2VyKGF1dGhLZXkpXG4gICAgICAgIHJldHVybiB0aGlzLmdldEVvc0luc3RhbmNlQnlTaWduYXR1cmVQcm92aWRlcihzaWduYXR1cmVQcm92aWRlcik7XG4gICAgfVxuXG4gICAgZ2V0QXV0aEtleShhdXRoS2V5UXVlcnk6IHN0cmluZywgYXV0aEtleVR5cGU/OiBBdXRoS2V5VHlwZSkge1xuICAgICAgICBjb25zdCBsb2NhbEF1dGhLZXlUeXBlID0gYXV0aEtleVR5cGUgfHwgdGhpcy5hdXRoS2V5VHlwZVxuXG4gICAgICAgIGlmIChsb2NhbEF1dGhLZXlUeXBlID09PSAncGxhaW4tYXV0aC1rZXknKSB7XG4gICAgICAgICAgICByZXR1cm4gYXV0aEtleVF1ZXJ5XG4gICAgICAgIH1cblxuICAgICAgICBpZiAobG9jYWxBdXRoS2V5VHlwZSA9PT0gJ2F1dGgta2V5LXNlYXJjaC1jYWxsYmFjaycpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5hdXRoS2V5U2VhcmNoQ2FsbGJhY2spIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBvbm8obmV3IEVycm9yKCdGb3IgYXV0aEtleVR5cGU9d2lmLXNlYXJjaC1jYWxsYmFjayB3aWZTZWFyY2hDYWxsYmFjayBuZWVkIHRvIGRlZmluZScpKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYXV0aEtleVNlYXJjaENhbGxiYWNrKGF1dGhLZXlRdWVyeSlcbiAgICAgICAgfVxuXG4gICAgICAgIHRocm93IG9ubyhuZXcgTm90SW1wbGVtZW50ZWRFcnJvcignTm90IGltcGxlbWVudGVkIGF1dGhLZXlUeXBlJykpXG4gICAgfVxuXG4gICAgYXN5bmMgdHJhbnNhY3RCeUF1dGhLZXkoXG4gICAgICAgIGF1dGhLZXk6IHN0cmluZyxcbiAgICAgICAgdHJhbnNhY3Rpb246IFRyYW5zYWN0aW9uLFxuICAgICAgICBjb25maWc/OiBUcmFuc2FjdENvbmZpZ1xuICAgICk6IFByb21pc2U8VHJhbnNhY3RSZXN1bHQgfCBSZWFkT25seVRyYW5zYWN0UmVzdWx0IHwgUHVzaFRyYW5zYWN0aW9uQXJncz4ge1xuICAgICAgICBjb25zdCBlb3MgPSBhd2FpdCB0aGlzLm1ha2VFb3NJbnN0YW5jZShhdXRoS2V5KVxuICAgICAgICByZXR1cm4gZW9zLnRyYW5zYWN0KHRyYW5zYWN0aW9uLCBjb25maWcpXG4gICAgfVxuXG4gICAgYXN5bmMgdHJhbnNhY3QoXG4gICAgICAgIGF1dGhLZXlRdWVyeTogc3RyaW5nLFxuICAgICAgICB0cmFuc2FjdGlvbjogVHJhbnNhY3Rpb24sXG4gICAgICAgIGNvbmZpZz86IFRyYW5zYWN0Q29uZmlnLFxuICAgICAgICBhdXRoS2V5VHlwZT86IEF1dGhLZXlUeXBlLFxuICAgICk6IFByb21pc2U8VHJhbnNhY3RSZXN1bHQgfCBSZWFkT25seVRyYW5zYWN0UmVzdWx0IHwgUHVzaFRyYW5zYWN0aW9uQXJncz4ge1xuICAgICAgICBjb25zdCBhdXRoS2V5ID0gYXdhaXQgdGhpcy5nZXRBdXRoS2V5KGF1dGhLZXlRdWVyeSwgYXV0aEtleVR5cGUpXG5cbiAgICAgICAgaWYgKCFhdXRoS2V5KSB7XG4gICAgICAgICAgICB0aHJvdyBvbm8obmV3IEVycm9yKCdhdXRoS2V5IGNhbm5vdCBiZSBlbXB0eScpKVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNhY3RCeUF1dGhLZXkoYXV0aEtleSwgdHJhbnNhY3Rpb24sIGNvbmZpZylcbiAgICB9XG5cbiAgICBhc3luYyBlbmNyeXB0TWVzc2FnZShcbiAgICAgICAgYXV0aEtleVF1ZXJ5OiBzdHJpbmcsXG4gICAgICAgIHB1YmxpY0tleTogc3RyaW5nLFxuICAgICAgICBtZXNzYWdlOiBzdHJpbmcsXG4gICAgICAgIG1lbW8/OiBzdHJpbmcsXG4gICAgICAgIGF1dGhLZXlUeXBlPzogQXV0aEtleVR5cGUsXG4gICAgKSB7XG4gICAgICAgIGNvbnN0IGF1dGhLZXkgPSBhd2FpdCB0aGlzLmdldEF1dGhLZXkoYXV0aEtleVF1ZXJ5LCBhdXRoS2V5VHlwZSlcblxuICAgICAgICBpZiAoIWF1dGhLZXkpIHtcbiAgICAgICAgICAgIHRocm93IG9ubyhuZXcgRXJyb3IoJ2F1dGhLZXkgY2Fubm90IGJlIGVtcHR5JykpXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwZXJtaXNzaW9uS2V5ID0gYXdhaXQgdGhpcy5yZWFkQXBpLmdldFBlcm1pc3Npb25LZXlCeU5hbWUocHVibGljS2V5LCBcImFjdGl2ZVwiKVxuXG4gICAgICAgIGlmICghcGVybWlzc2lvbktleSkge1xuICAgICAgICAgICAgdGhyb3cgb25vKG5ldyBFcnJvcigncGVybWlzc2lvbktleSBjYW5ub3QgYmUgZW1wdHknKSlcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHByZXBhcmVkTWVzc2FnZSA9IGJ0b2EodW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KG1lc3NhZ2UpKSlcbiAgICAgICAgcmV0dXJuIHRoaXMuY2hhaW5DcnlwdC5lbmNyeXB0KGF1dGhLZXksIHBlcm1pc3Npb25LZXksIHByZXBhcmVkTWVzc2FnZSwgbWVtbylcbiAgICB9XG5cbiAgICBhc3luYyBkZWNyeXB0TWVzc2FnZShcbiAgICAgICAgYXV0aEtleVF1ZXJ5OiBzdHJpbmcsXG4gICAgICAgIHB1YmxpY0tleTogc3RyaW5nLFxuICAgICAgICBtZXNzYWdlOiBzdHJpbmcsXG4gICAgICAgIG1lbW8/OiBzdHJpbmcsXG4gICAgICAgIGF1dGhLZXlUeXBlPzogQXV0aEtleVR5cGUsXG4gICAgKSB7XG4gICAgICAgIGNvbnN0IGF1dGhLZXkgPSBhd2FpdCB0aGlzLmdldEF1dGhLZXkoYXV0aEtleVF1ZXJ5LCBhdXRoS2V5VHlwZSlcblxuICAgICAgICBpZiAoIWF1dGhLZXkpIHtcbiAgICAgICAgICAgIHRocm93IG9ubyhuZXcgRXJyb3IoJ2F1dGhLZXkgY2Fubm90IGJlIGVtcHR5JykpXG4gICAgICAgIH1cblxuICAgICAgICBsZXQgcGVybWlzc2lvbktleSA9IGF3YWl0IHRoaXMucmVhZEFwaS5nZXRQZXJtaXNzaW9uS2V5QnlOYW1lKHB1YmxpY0tleSwgXCJnYXRld2F5XCIpXG5cbiAgICAgICAgaWYgKCFwZXJtaXNzaW9uS2V5KSB7XG4gICAgICAgICAgICBwZXJtaXNzaW9uS2V5ID0gYXdhaXQgdGhpcy5yZWFkQXBpLmdldFBlcm1pc3Npb25LZXlCeU5hbWUocHVibGljS2V5LCBcImFjdGl2ZVwiKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFwZXJtaXNzaW9uS2V5KSB7XG4gICAgICAgICAgICB0aHJvdyBvbm8obmV3IEVycm9yKCdwZXJtaXNzaW9uS2V5IGNhbm5vdCBiZSBlbXB0eScpKVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZGVjcnlwdGVkTWVzc2FnZSA9IGF3YWl0IHRoaXMuY2hhaW5DcnlwdC5kZWNyeXB0KGF1dGhLZXksIHBlcm1pc3Npb25LZXksIG1lc3NhZ2UsIG1lbW8pXG5cbiAgICAgICAgcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudChlc2NhcGUoYXRvYihkZWNyeXB0ZWRNZXNzYWdlKSkpXG4gICAgfVxuXG4gICAgbWFrZVZhbHVlQXNTdHIodmFsdWU6IGFueSk6IHN0cmluZyB7XG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgfHwgdHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbicpIHtcbiAgICAgICAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpXG4gICAgICAgIH1cblxuICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlLm1hcChpdGVtID0+IHRoaXMubWFrZVZhbHVlQXNTdHIoaXRlbSkpLmpvaW4oJywnKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHZhbHVlKS5zb3J0KClcbiAgICAgICAgICAgIHJldHVybiBrZXlzLm1hcChrZXkgPT4gYCR7a2V5fT0ke3RoaXMubWFrZVZhbHVlQXNTdHIodmFsdWVba2V5XSl9YCkuam9pbignJicpXG4gICAgICAgIH1cblxuICAgICAgICB0aHJvdyBvbm8obmV3IEVycm9yKCdVbnN1cHBvcnRlZCB2YWx1ZSB0eXBlJykpXG4gICAgfVxuXG4gICAgb2JqVG9TdGFibGVNZXNzYWdlKGRpY3Q6IFJlY29yZDxzdHJpbmcsIGFueT4pIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubWFrZVZhbHVlQXNTdHIoZGljdClcbiAgICB9XG5cbiAgICBidG9hRXNjYXBlKHN0cjogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBidG9hKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChzdHIpKSlcbiAgICB9XG5cbiAgICBhc3luYyBzaWduTWVzc2FnZShcbiAgICAgICAgYXV0aEtleVF1ZXJ5OiBzdHJpbmcsXG4gICAgICAgIHB1YmxpY0tleTogc3RyaW5nLFxuICAgICAgICBtZXNzYWdlOiBzdHJpbmcsXG4gICAgICAgIGF1dGhLZXlUeXBlPzogQXV0aEtleVR5cGUsXG4gICAgKSB7XG4gICAgICAgIGNvbnN0IGF1dGhLZXkgPSBhd2FpdCB0aGlzLmdldEF1dGhLZXkoYXV0aEtleVF1ZXJ5LCBhdXRoS2V5VHlwZSlcblxuICAgICAgICBpZiAoIWF1dGhLZXkpIHtcbiAgICAgICAgICAgIHRocm93IG9ubyhuZXcgRXJyb3IoJ2F1dGhLZXkgY2Fubm90IGJlIGVtcHR5JykpXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwcmVwYXJlZE1lc3NhZ2UgPSB0aGlzLmJ0b2FFc2NhcGUobWVzc2FnZSlcbiAgICAgICAgcmV0dXJuIHRoaXMuY2hhaW5DcnlwdC5zaWduKGF1dGhLZXksIHByZXBhcmVkTWVzc2FnZSlcbiAgICB9XG5cbiAgICBhc3luYyB2ZXJpZnlNZXNzYWdlKFxuICAgICAgICBwdWJsaWNLZXk6IHN0cmluZyxcbiAgICAgICAgbWVzc2FnZTogc3RyaW5nLFxuICAgICAgICBzaWduYXR1cmU6IHN0cmluZyxcbiAgICApIHtcbiAgICAgICAgY29uc3QgcHJlcGFyZWRNZXNzYWdlID0gdGhpcy5idG9hRXNjYXBlKG1lc3NhZ2UpXG4gICAgICAgIHJldHVybiB0aGlzLmNoYWluQ3J5cHQudmVyaWZ5KHB1YmxpY0tleSwgcHJlcGFyZWRNZXNzYWdlLCBzaWduYXR1cmUpXG4gICAgfVxuXG4gICAgYXN5bmMgc2lnbk9iamVjdChcbiAgICAgICAgYXV0aEtleVF1ZXJ5OiBzdHJpbmcsXG4gICAgICAgIHB1YmxpY0tleTogc3RyaW5nLFxuICAgICAgICBkaWN0OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+LFxuICAgICAgICBhdXRoS2V5VHlwZT86IEF1dGhLZXlUeXBlLFxuICAgICkge1xuICAgICAgICBjb25zdCBtZXNzYWdlID0gdGhpcy5vYmpUb1N0YWJsZU1lc3NhZ2UoZGljdClcbiAgICAgICAgcmV0dXJuIHRoaXMuc2lnbk1lc3NhZ2UoYXV0aEtleVF1ZXJ5LCBwdWJsaWNLZXksIG1lc3NhZ2UsIGF1dGhLZXlUeXBlKVxuICAgIH1cblxuICAgIGFzeW5jIHZlcmlmeU9iamVjdChcbiAgICAgICAgcHVibGljS2V5OiBzdHJpbmcsXG4gICAgICAgIGRpY3Q6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4sXG4gICAgICAgIHNpZ25hdHVyZTogc3RyaW5nLFxuICAgICkge1xuICAgICAgICBjb25zdCBtZXNzYWdlID0gdGhpcy5vYmpUb1N0YWJsZU1lc3NhZ2UoZGljdClcbiAgICAgICAgcmV0dXJuIHRoaXMudmVyaWZ5TWVzc2FnZShwdWJsaWNLZXksIG1lc3NhZ2UsIHNpZ25hdHVyZSlcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IENoYWluXG4iXX0=