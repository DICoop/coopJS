import BaseContract from './base';
class CoreContract extends BaseContract {
    constructor(api, tableCodeConfig) {
        super(api, tableCodeConfig, 'core');
    }
    async getUserPower(username, hostname) {
        const powerData = await this.getSingleTableRow({
            table: 'power3',
            scope: hostname,
            lower_bound: username,
            upper_bound: username,
            limit: 1,
        });
        return powerData || {
            delegated: 0,
            frozen: 0,
            power: 0,
            staked: 0,
            username,
            with_badges: 0,
        };
    }
    async getMarket(host, userPower) {
        const market = await this.getSingleTableRow({
            table: 'powermarket',
            scope: host.username,
            lower_bound: 0,
            limit: 1,
        });
        market.liquid = host.total_shares - Number(market.base.balance.split(' ')[0]);
        if (market.liquid === 0) {
            market.liquid = 1;
        }
        const price1 = Number(market.quote.balance.split(' ')[0]);
        const price2 = Number(market.base.balance.split(' ')[0]);
        market.price = {
            buy: (price1 / price2).toFixed(host.quote_precision),
            sell: (price1 / price2).toFixed(host.quote_precision),
        };
        market.stake = (userPower.power / market.liquid * 100).toFixed(3) || '0';
        const res = Math.max(userPower.power * price1 / (price2 + userPower.power), 0);
        if (res) {
            market.if_user_sell_all = res.toFixed(4);
        }
        return market;
    }
    getReports(username) {
        return this.getTableRows({
            table: 'reports3',
            scope: 'core',
            lower_bound: username,
            upper_bound: username,
            limit: 100,
            index_position: 4,
            key_type: 'i64',
            getAllRows: true,
        }).then(result => result.rows);
    }
    getTasksRaw() {
        return this.getTableRows({
            table: 'tasks',
            scope: 'core',
            lower_bound: 0,
            limit: 100,
            getAllRows: true,
            parseMetaAsJson: true,
        }).then(result => result.rows);
    }
    getBadgesRaw() {
        return this.getTableRows({
            table: 'badges',
            scope: 'core',
            lower_bound: 0,
            limit: 100,
            getAllRows: true,
        }).then(result => result.rows);
    }
    async getTasks(username, reports) {
        const tasks = await this.getTasksRaw();
        const badges = await this.getBadgesRaw();
        const result = [];
        for (const task of tasks) {
            if (task.validated !== 1) {
                continue;
            }
            const taskReports = reports.filter(report => report.task_id === task.task_id);
            const userReports = taskReports.filter(report => report.username === username);
            if (userReports.length > 0) {
                continue;
            }
            const no_reports_on_check = taskReports.every(report => !report.need_check && report.approved);
            const badge = task.with_badge ? badges.find(b => task.badge_id == b.id) : undefined;
            const taskResult = {
                ...task,
                no_reports_on_check,
                has_report: false,
                report_approved: false,
                badge,
                reports: taskReports,
                user_reports: userReports,
            };
            result.push(taskResult);
        }
        return result;
    }
    getHost(hostname) {
        return this.getSingleTableRow({
            scope: hostname,
            table: 'hosts',
            lower_bound: 0
        });
    }
}
export default CoreContract;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29yZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3RzL3NyYy9ibG9ja2NoYWluL2NvbnRyYWN0cy9jb3JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sWUFBWSxNQUFNLFFBQVEsQ0FBQTtBQTJMakMsTUFBTSxZQUFhLFNBQVEsWUFBWTtJQUNyQyxZQUFZLEdBQVksRUFBRSxlQUFnQztRQUN4RCxLQUFLLENBQUMsR0FBRyxFQUFFLGVBQWUsRUFBRSxNQUFNLENBQUMsQ0FBQTtJQUNyQyxDQUFDO0lBRUQsS0FBSyxDQUFDLFlBQVksQ0FBQyxRQUFnQixFQUFFLFFBQWdCO1FBQ25ELE1BQU0sU0FBUyxHQUF5QixNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBZ0I7WUFDbEYsS0FBSyxFQUFFLFFBQVE7WUFDZixLQUFLLEVBQUUsUUFBUTtZQUNmLFdBQVcsRUFBRSxRQUFRO1lBQ3JCLFdBQVcsRUFBRSxRQUFRO1lBQ3JCLEtBQUssRUFBRSxDQUFDO1NBQ1QsQ0FBQyxDQUFBO1FBRUYsT0FBTyxTQUFTLElBQUk7WUFDbEIsU0FBUyxFQUFFLENBQUM7WUFDWixNQUFNLEVBQUUsQ0FBQztZQUNULEtBQUssRUFBRSxDQUFDO1lBQ1IsTUFBTSxFQUFFLENBQUM7WUFDVCxRQUFRO1lBQ1IsV0FBVyxFQUFFLENBQUM7U0FDZixDQUFBO0lBQ0gsQ0FBQztJQUVELEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBYyxFQUFFLFNBQXdCO1FBQ3RELE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLGlCQUFpQixDQUFhO1lBQ3RELEtBQUssRUFBRSxhQUFhO1lBQ3BCLEtBQUssRUFBRSxJQUFJLENBQUMsUUFBUTtZQUNwQixXQUFXLEVBQUUsQ0FBQztZQUNkLEtBQUssRUFBRSxDQUFDO1NBQ1QsQ0FBQyxDQUFBO1FBRUYsTUFBTSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsWUFBWSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMs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QUE7SUFDZixDQUFDO0lBRUQsT0FBTyxDQUFDLFFBQWdCO1FBQ3RCLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFXO1lBQ3RDLEtBQUssRUFBRSxRQUFRO1lBQ2YsS0FBSyxFQUFFLE9BQU87WUFDZCxXQUFXLEVBQUUsQ0FBQztTQUNmLENBQUMsQ0FBQTtJQUNKLENBQUM7Q0FDRjtBQUVELGVBQWUsWUFBWSxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWRBcGkgZnJvbSAnLi4vcmVhZEFwaSdcbmltcG9ydCB7VGFibGVDb2RlQ29uZmlnfSBmcm9tICcuLi90eXBlcydcbmltcG9ydCBCYXNlQ29udHJhY3QgZnJvbSAnLi9iYXNlJ1xuXG5pbnRlcmZhY2UgVXNlclBvd2VyRGF0YSB7XG4gIGRlbGVnYXRlZDogbnVtYmVyXG4gIGZyb3plbjogbnVtYmVyXG4gIHBvd2VyOiBudW1iZXJcbiAgc3Rha2VkOiBudW1iZXJcbiAgdXNlcm5hbWU6IHN0cmluZ1xuICB3aXRoX2JhZGdlczogbnVtYmVyXG59XG5cbmludGVyZmFjZSBNYXJrZXRCYWxhbmNlIHtcbiAgYmFsYW5jZTogc3RyaW5nXG4gIHdlaWdodDogc3RyaW5nXG4gIGNvbnRyYWN0OiBzdHJpbmdcbn1cblxuaW50ZXJmYWNlIE1hcmtldFByaWNlIHtcbiAgYnV5OiBzdHJpbmdcbiAgc2VsbDogc3RyaW5nXG59XG5cbmludGVyZmFjZSBNYXJrZXREYXRhIHtcbiAgYmFzZTogTWFya2V0QmFsYW5jZVxuICBpZDogbnVtYmVyXG4gIG5hbWU6IHN0cmluZ1xuICBxdW90ZTogTWFya2V0QmFsYW5jZVxuICBzdXBwbHk6IHN0cmluZ1xuICB2ZXN0aW5nX3NlY29uZHM6IG51bWJlclxuICBsaXF1aWQ6IG51bWJlciAvLyBnZW5lcmF0ZWQgcHJvcGVydHlcbiAgcHJpY2U6IE1hcmtldFByaWNlIC8vIGdlbmVyYXRlZCBwcm9wZXJ0eVxuICBzdGFrZTogc3RyaW5nIC8vIGdlbmVyYXRlZCBwcm9wZXJ0eVxuICBpZl91c2VyX3NlbGxfYWxsPzogc3RyaW5nIC8vIGdlbmVyYXRlZCBwcm9wZXJ0eVxufVxuXG5pbnRlcmZhY2UgUmVwb3J0RGF0YSB7XG4gIGFwcHJvdmVkOiBudW1iZXJcbiAgYmFsYW5jZTogc3RyaW5nXG4gIGNvbW1lbnQ6IHN0cmluZ1xuICBjb3VudDogbnVtYmVyXG4gIGNyZWF0ZWRfYXQ6IHN0cmluZ1xuICBjdXJhdG9yOiBzdHJpbmdcbiAgZGF0YTogc3RyaW5nXG4gIGRpc3RyaWJ1dGVkOiBudW1iZXJcbiAgZXhwaXJlZF9hdDogc3RyaW5nXG4gIGdvYWxfaWQ6IHN0cmluZ1xuICBuZWVkX2NoZWNrOiBudW1iZXJcbiAgcmVwb3J0X2lkOiBudW1iZXJcbiAgcmVxdWVzdGVkOiBzdHJpbmdcbiAgc3RhdHVzOiBzdHJpbmdcbiAgdGFza19pZDogc3RyaW5nXG4gIHRvdGFsX3ZvdGVzOiBudW1iZXJcbiAgdHlwZTogbnVtYmVyXG4gIHVzZXJuYW1lOiBzdHJpbmdcbiAgdm90ZXJzOiBhbnlbXVxufVxuXG5pbnRlcmZhY2UgVGFza0RhdGEge1xuICBhY3RpdmU6IG51bWJlclxuICBiYWRnZV9pZDogbnVtYmVyXG4gIGJhdGNoOiBhbnlbXVxuICBiZW5lZmFjdG9yOiBzdHJpbmdcbiAgY2FsZW5kYXI6IGFueVtdXG4gIGNvbXBsZXRlZDogbnVtYmVyXG4gIGNyZWF0ZWRfYXQ6IHN0cmluZ1xuICBjcmVhdG9yOiBzdHJpbmdcbiAgY3VyYXRvcjogc3RyaW5nXG4gIGRhdGE6IHN0cmluZ1xuICBkb2VyOiBzdHJpbmdcbiAgZHVyYXRpb246IG51bWJlclxuICBleHBpcmVkX2F0OiBzdHJpbmdcbiAgZm9yX2VhY2g6IHN0cmluZ1xuICBmdW5kZWQ6IHN0cmluZ1xuICBnaWZ0ZWRfYmFkZ2VzOiBudW1iZXJcbiAgZ2lmdGVkX3Bvd2VyOiBudW1iZXJcbiAgZ29hbF9pZDogc3RyaW5nXG4gIGhvc3Q6IHN0cmluZ1xuICBpc19iYXRjaDogbnVtYmVyXG4gIGlzX2VuY3J5cHRlZDogbnVtYmVyXG4gIGlzX3B1YmxpYzogbnVtYmVyXG4gIGlzX3JlZ3VsYXI6IG51bWJlclxuICBsZXZlbDogbnVtYmVyXG4gIG1ldGE6IGFueVxuICBwYXJlbnRfYmF0Y2hfaWQ6IG51bWJlclxuICBwZXJtbGluazogc3RyaW5nXG4gIHByaW9yaXR5OiBudW1iZXJcbiAgcHVibGljX2tleTogc3RyaW5nXG4gIHJlbWFpbjogc3RyaW5nXG4gIHJlcG9ydHNfY291bnQ6IG51bWJlclxuICByZXF1ZXN0ZWQ6IHN0cmluZ1xuICByb2xlOiBzdHJpbmdcbiAgc3RhcnRfYXQ6IHN0cmluZ1xuICBzdGF0dXM6IHN0cmluZ1xuICBzdWdnZXN0ZXI6IHN0cmluZ1xuICB0YXNrX2lkOiBzdHJpbmdcbiAgdGl0bGU6IHN0cmluZ1xuICB0b3RhbF92b3RlczogbnVtYmVyXG4gIHR5cGU6IHN0cmluZ1xuICB2YWxpZGF0ZWQ6IG51bWJlclxuICB2b3RlcnM6IGFueVtdXG4gIHdpdGhfYmFkZ2U6IG51bWJlclxufVxuXG5pbnRlcmZhY2UgQmFkZ2VEYXRhIHtcbiAgY2FwdGlvbjogc3RyaW5nXG4gIGRlc2NyaXB0aW9uOiBzdHJpbmdcbiAgaWQ6IG51bWJlclxuICBpdXJsOiBzdHJpbmdcbiAgcGljOiBzdHJpbmdcbiAgcG93ZXI6IG51bWJlclxuICByZW1haW46IG51bWJlclxuICB0b3RhbDogbnVtYmVyXG59XG5cbmludGVyZmFjZSBUYXNrRGF0YVJlc3VsdCBleHRlbmRzIFRhc2tEYXRhIHtcbiAgcmVwb3J0czogUmVwb3J0RGF0YVtdXG4gIHVzZXJfcmVwb3J0czogUmVwb3J0RGF0YVtdXG4gIG5vX3JlcG9ydHNfb25fY2hlY2s6IGJvb2xlYW5cbiAgaGFzX3JlcG9ydDogYm9vbGVhblxuICByZXBvcnRfYXBwcm92ZWQ6IGJvb2xlYW5cbiAgYmFkZ2U/OiBCYWRnZURhdGFcbn1cblxuXG5pbnRlcmZhY2UgSG9zdERhdGEge1xuICBhY2hpZXZlZF9nb2FsczogbnVtYmVyXG4gIGFjdGl2YXRlZDogbnVtYmVyXG4gIGFob3N0OiBzdHJpbmdcbiAgYXBwcm92ZWRfcmVwb3J0czogbnVtYmVyXG4gIGFyY2hpdGVjdDogc3RyaW5nXG4gIGFzc2V0X29uX3NhbGU6IHN0cmluZ1xuICBhc3NldF9vbl9zYWxlX3ByZWNpc2lvbjogbnVtYmVyXG4gIGFzc2V0X29uX3NhbGVfc3ltYm9sOiBzdHJpbmdcbiAgY2Z1bmRfcGVyY2VudDogbnVtYmVyXG4gIGNoYXRfbW9kZTogc3RyaW5nXG4gIGNob3N0czogYW55W11cbiAgY29tcGxldGVkX3Rhc2tzOiBudW1iZXJcbiAgY29uc2Vuc3VzX3BlcmNlbnQ6IG51bWJlclxuICBjdXJyZW50X2N5Y2xlX251bTogbnVtYmVyXG4gIGN1cnJlbnRfcG9vbF9pZDogbnVtYmVyXG4gIGN1cnJlbnRfcG9vbF9udW06IG51bWJlclxuICBjeWNsZV9zdGFydF9pZDogbnVtYmVyXG4gIGRhY19tb2RlOiBudW1iZXJcbiAgZGFjc19wZXJjZW50OiBudW1iZXJcbiAgZGlyZWN0X2dvYWxfd2l0aGRyYXc6IG51bWJlclxuICBmaG9zdHM6IGFueVtdXG4gIGZob3N0c19tb2RlOiBudW1iZXJcbiAgZ3Nwb25zb3JfbW9kZWw6IGFueVtdXG4gIGhmdW5kX3BlcmNlbnQ6IG51bWJlclxuICBob3BlcmF0b3I6IHN0cmluZ1xuICBsZXZlbHM6IG51bWJlcltdXG4gIG1ldGE6IHN0cmluZ1xuICBuZWVkX3N3aXRjaDogbnVtYmVyXG4gIG5vbl9hY3RpdmVfY2hvc3Q6IG51bWJlclxuICBwYXJhbWV0ZXJzX3NldHRlZDogbnVtYmVyXG4gIHBheWVkOiBudW1iZXJcbiAgcG93ZXJfbWFya2V0X2lkOiBzdHJpbmdcbiAgcHJlY2lzaW9uOiBudW1iZXJcbiAgcHJpb3JpdHlfZmxhZzogbnVtYmVyXG4gIHB1cnBvc2U6IHN0cmluZ1xuICBxdW90ZV9hbW91bnQ6IHN0cmluZ1xuICBxdW90ZV9wcmVjaXNpb246IG51bWJlclxuICBxdW90ZV9zeW1ib2w6IHN0cmluZ1xuICBxdW90ZV90b2tlbl9jb250cmFjdDogc3RyaW5nXG4gIHJlZmVycmFsX3BlcmNlbnQ6IG51bWJlclxuICByZWdpc3RlcmVkX2F0OiBzdHJpbmdcbiAgcm9vdF90b2tlbjogc3RyaW5nXG4gIHJvb3RfdG9rZW5fY29udHJhY3Q6IHN0cmluZ1xuICBzYWxlX2lzX2VuYWJsZWQ6IG51bWJlclxuICBzYWxlX21vZGU6IHN0cmluZ1xuICBzYWxlX3NoaWZ0OiBudW1iZXJcbiAgc2FsZV90b2tlbl9jb250cmFjdDogc3RyaW5nXG4gIHN5bWJvbDogc3RyaW5nXG4gIHN5c19wZXJjZW50OiBudW1iZXJcbiAgdGl0bGU6IHN0cmluZ1xuICB0b19wYXk6IHN0cmluZ1xuICB0b3RhbF9kYWNzX3dlaWdodDogbnVtYmVyXG4gIHRvdGFsX2dvYWxzOiBudW1iZXJcbiAgdG90YWxfcmVwb3J0czogbnVtYmVyXG4gIHRvdGFsX3NoYXJlczogbnVtYmVyXG4gIHRvdGFsX3Rhc2tzOiBudW1iZXJcbiAgdHlwZTogc3RyaW5nXG4gIHVzZXJuYW1lOiBzdHJpbmdcbiAgdm90aW5nX29ubHlfdXA6IG51bWJlclxufVxuXG5cbmNsYXNzIENvcmVDb250cmFjdCBleHRlbmRzIEJhc2VDb250cmFjdCB7XG4gIGNvbnN0cnVjdG9yKGFwaTogUmVhZEFwaSwgdGFibGVDb2RlQ29uZmlnOiBUYWJsZUNvZGVDb25maWcpIHtcbiAgICBzdXBlcihhcGksIHRhYmxlQ29kZUNvbmZpZywgJ2NvcmUnKVxuICB9XG5cbiAgYXN5bmMgZ2V0VXNlclBvd2VyKHVzZXJuYW1lOiBzdHJpbmcsIGhvc3RuYW1lOiBzdHJpbmcpIHtcbiAgICBjb25zdCBwb3dlckRhdGE6IFVzZXJQb3dlckRhdGEgfCBudWxsID0gYXdhaXQgdGhpcy5nZXRTaW5nbGVUYWJsZVJvdzxVc2VyUG93ZXJEYXRhPih7XG4gICAgICB0YWJsZTogJ3Bvd2VyMycsXG4gICAgICBzY29wZTogaG9zdG5hbWUsXG4gICAgICBsb3dlcl9ib3VuZDogdXNlcm5hbWUsXG4gICAgICB1cHBlcl9ib3VuZDogdXNlcm5hbWUsXG4gICAgICBsaW1pdDogMSxcbiAgICB9KVxuXG4gICAgcmV0dXJuIHBvd2VyRGF0YSB8fCB7XG4gICAgICBkZWxlZ2F0ZWQ6IDAsXG4gICAgICBmcm96ZW46IDAsXG4gICAgICBwb3dlcjogMCxcbiAgICAgIHN0YWtlZDogMCxcbiAgICAgIHVzZXJuYW1lLFxuICAgICAgd2l0aF9iYWRnZXM6IDAsXG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0TWFya2V0KGhvc3Q6IEhvc3REYXRhLCB1c2VyUG93ZXI6IFVzZXJQb3dlckRhdGEpIHtcbiAgICBjb25zdCBtYXJrZXQgPSBhd2FpdCB0aGlzLmdldFNpbmdsZVRhYmxlUm93PE1hcmtldERhdGE+KHtcbiAgICAgIHRhYmxlOiAncG93ZXJtYXJrZXQnLFxuICAgICAgc2NvcGU6IGhvc3QudXNlcm5hbWUsXG4gICAgICBsb3dlcl9ib3VuZDogMCxcbiAgICAgIGxpbWl0OiAxLFxuICAgIH0pXG5cbiAgICBtYXJrZXQubGlxdWlkID0gaG9zdC50b3RhbF9zaGFyZXMgLSBOdW1iZXIobWFya2V0LmJhc2UuYmFsYW5jZS5zcGxpdCgnICcpWzBdKVxuICAgIGlmIChtYXJrZXQubGlxdWlkID09PSAwKSB7XG4gICAgICBtYXJrZXQubGlxdWlkID0gMVxuICAgIH1cblxuICAgIGNvbnN0IHByaWNlMSA9IE51bWJlcihtYXJrZXQucXVvdGUuYmFsYW5jZS5zcGxpdCgnICcpWzBdKVxuICAgIGNvbnN0IHByaWNlMiA9IE51bWJlcihtYXJrZXQuYmFzZS5iYWxhbmNlLnNwbGl0KCcgJylbMF0pXG5cbiAgICBtYXJrZXQucHJpY2UgPSB7XG4gICAgICBidXk6IChwcmljZTEgLyBwcmljZTIpLnRvRml4ZWQoaG9zdC5xdW90ZV9wcmVjaXNpb24pLFxuICAgICAgc2VsbDogKHByaWNlMSAvIHByaWNlMikudG9GaXhlZChob3N0LnF1b3RlX3ByZWNpc2lvbiksXG4gICAgfVxuXG4gICAgbWFya2V0LnN0YWtlID0gKHVzZXJQb3dlci5wb3dlciAvIG1hcmtldC5saXF1aWQgKiAxMDApLnRvRml4ZWQoMykgfHwgJzAnXG5cbiAgICBjb25zdCByZXMgPSBNYXRoLm1heCh1c2VyUG93ZXIucG93ZXIgKiBwcmljZTEgLyAoIHByaWNlMiArIHVzZXJQb3dlci5wb3dlciksIDApXG4gICAgaWYgKHJlcykge1xuICAgICAgbWFya2V0LmlmX3VzZXJfc2VsbF9hbGwgPSByZXMudG9GaXhlZCg0KVxuICAgIH1cblxuICAgIHJldHVybiBtYXJrZXRcbiAgfVxuXG4gIGdldFJlcG9ydHModXNlcm5hbWU6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLmdldFRhYmxlUm93czxSZXBvcnREYXRhPih7XG4gICAgICB0YWJsZTogJ3JlcG9ydHMzJyxcbiAgICAgIHNjb3BlOiAnY29yZScsXG4gICAgICBsb3dlcl9ib3VuZDogdXNlcm5hbWUsXG4gICAgICB1cHBlcl9ib3VuZDogdXNlcm5hbWUsXG4gICAgICBsaW1pdDogMTAwLFxuICAgICAgaW5kZXhfcG9zaXRpb246IDQsXG4gICAgICBrZXlfdHlwZTogJ2k2NCcsXG4gICAgICBnZXRBbGxSb3dzOiB0cnVlLFxuICAgIH0pLnRoZW4ocmVzdWx0ID0+IHJlc3VsdC5yb3dzKVxuICB9XG5cbiAgZ2V0VGFza3NSYXcoKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0VGFibGVSb3dzPFRhc2tEYXRhPih7XG4gICAgICB0YWJsZTogJ3Rhc2tzJyxcbiAgICAgIHNjb3BlOiAnY29yZScsXG4gICAgICBsb3dlcl9ib3VuZDogMCxcbiAgICAgIGxpbWl0OiAxMDAsXG4gICAgICBnZXRBbGxSb3dzOiB0cnVlLFxuICAgICAgcGFyc2VNZXRhQXNKc29uOiB0cnVlLFxuICAgIH0pLnRoZW4ocmVzdWx0ID0+IHJlc3VsdC5yb3dzKVxuICB9XG5cbiAgZ2V0QmFkZ2VzUmF3KCkge1xuICAgIHJldHVybiB0aGlzLmdldFRhYmxlUm93czxCYWRnZURhdGE+KHtcbiAgICAgIHRhYmxlOiAnYmFkZ2VzJyxcbiAgICAgIHNjb3BlOiAnY29yZScsXG4gICAgICBsb3dlcl9ib3VuZDogMCxcbiAgICAgIGxpbWl0OiAxMDAsXG4gICAgICBnZXRBbGxSb3dzOiB0cnVlLFxuICAgIH0pLnRoZW4ocmVzdWx0ID0+IHJlc3VsdC5yb3dzKVxuICB9XG5cbiAgYXN5bmMgZ2V0VGFza3ModXNlcm5hbWU6IHN0cmluZywgcmVwb3J0czogUmVwb3J0RGF0YVtdKSB7XG4gICAgY29uc3QgdGFza3MgPSBhd2FpdCB0aGlzLmdldFRhc2tzUmF3KClcbiAgICBjb25zdCBiYWRnZXMgPSBhd2FpdCB0aGlzLmdldEJhZGdlc1JhdygpXG5cbiAgICBjb25zdCByZXN1bHQ6IFRhc2tEYXRhUmVzdWx0W10gPSBbXVxuXG4gICAgZm9yIChjb25zdCB0YXNrIG9mIHRhc2tzKSB7XG4gICAgICBpZiAodGFzay52YWxpZGF0ZWQgIT09IDEpIHtcbiAgICAgICAgY29udGludWVcbiAgICAgIH1cblxuICAgICAgY29uc3QgdGFza1JlcG9ydHMgPSByZXBvcnRzLmZpbHRlcihyZXBvcnQgPT4gcmVwb3J0LnRhc2tfaWQgPT09IHRhc2sudGFza19pZClcbiAgICAgIGNvbnN0IHVzZXJSZXBvcnRzID0gdGFza1JlcG9ydHMuZmlsdGVyKHJlcG9ydCA9PiByZXBvcnQudXNlcm5hbWUgPT09IHVzZXJuYW1lKVxuXG4gICAgICBpZiAodXNlclJlcG9ydHMubGVuZ3RoID4gMCkge1xuICAgICAgICBjb250aW51ZVxuICAgICAgfVxuXG4gICAgICBjb25zdCBub19yZXBvcnRzX29uX2NoZWNrID0gdGFza1JlcG9ydHMuZXZlcnkocmVwb3J0ID0+ICFyZXBvcnQubmVlZF9jaGVjayAmJiByZXBvcnQuYXBwcm92ZWQpXG5cbiAgICAgIGNvbnN0IGJhZGdlID0gdGFzay53aXRoX2JhZGdlID8gYmFkZ2VzLmZpbmQoYj0+IHRhc2suYmFkZ2VfaWQgPT0gYi5pZCkgOiB1bmRlZmluZWRcblxuICAgICAgY29uc3QgdGFza1Jlc3VsdDogVGFza0RhdGFSZXN1bHQgPSB7XG4gICAgICAgIC4uLnRhc2ssXG4gICAgICAgIG5vX3JlcG9ydHNfb25fY2hlY2ssXG4gICAgICAgIGhhc19yZXBvcnQ6IGZhbHNlLFxuICAgICAgICByZXBvcnRfYXBwcm92ZWQ6IGZhbHNlLFxuICAgICAgICBiYWRnZSxcbiAgICAgICAgcmVwb3J0czogdGFza1JlcG9ydHMsXG4gICAgICAgIHVzZXJfcmVwb3J0czogdXNlclJlcG9ydHMsXG4gICAgICB9XG5cbiAgICAgIHJlc3VsdC5wdXNoKHRhc2tSZXN1bHQpXG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdFxuICB9XG5cbiAgZ2V0SG9zdChob3N0bmFtZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0U2luZ2xlVGFibGVSb3c8SG9zdERhdGE+KHtcbiAgICAgIHNjb3BlOiBob3N0bmFtZSxcbiAgICAgIHRhYmxlOiAnaG9zdHMnLFxuICAgICAgbG93ZXJfYm91bmQ6IDBcbiAgICB9KVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IENvcmVDb250cmFjdFxuIl19